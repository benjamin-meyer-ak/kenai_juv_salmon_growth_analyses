# Bioenergetics Model Runs

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache=TRUE, collapse=TRUE)
```

```{r initialize script, echo = F}
# Clear environment
rm(list=ls())

#require packages
library(tidyverse)



# variant theme WITHOUT angled x-axis labels
bm_theme_1 <- theme(plot.title = element_text(size= 26, face = "bold"),        # plot title
                  axis.text.x = element_text(size=10),
                  axis.text.y = element_text(size=10),                       # x axis text
                  axis.title.x = element_text(size=16),                      # x axis title
                  axis.title.y = element_text(size=16)) +                    # y axis title
  theme(strip.text = element_text(face="bold", size=12),
        strip.background = element_rect(fill="lightblue", 
                                        colour="black",size=1)) 

```


## Introduction

In the previous chapter, we generated the input data structures needed to run bioenergetics simulations on each of our fish cohorts from observed field data. In this chapter, we will discuss executing these model runs using the RShiny software Fishbioenergetics 4.0.

### Original model runs

In Fall 2018 we used the model inputs based on field observations to run simulations in a modified version of Fishbioenergetics (FB4) v1.03 ([www.fishbioenergetics.org](http://fishbioenergetics.org/)). We used a modified version of the software because at the time, the available version did not fully suit our needs. The FB4 Shiny app was designed to run only one simulation at a time, requiring manual inputs to the user interface each time model inputs changed. Given that our two-step modeling process required \>100 unique model runs, manually executing these was not a viable approach. Thus, a software developer was contracted to assist in reconfiguring the Shiny app.

The modified version of FB4 we generated is available online at <https://bemeyer.shinyapps.io/FishBioenergetics/>. As of 5/27/2022 the app is not currently functioning except for the default "test simulation." It is unclear what is generating the error. More detail on this problem and its coming resolution is described as a GitHub Issue (see link, "[Unable to run Shiny app after upgrade to R version 4.2.0](https://github.com/benjamin-meyer-ak/kenai_juv_salmon_growth_analyses/issues/1)"). 

Since 2018, new releases of FB4 are designed to accommodate the modeling needs of this manuscript. However the data structure required for multiple model runs in FB4 v1.1.3 (most current version) is distinct from that which we used in 2018, and our data would require substantial revisions in order to interact with it.

At present, the software developer has been contacted to see if they can assist with resolving the GitHub Issue described above, and they should be available in early June 2022. Simultaneously, we are assessing if it is feasible to revise our data structure (generated in the previous chapter) to interact with the FB4 version available from the original authors.

<br>

### Original model results (2018)

Here we will examine the model simulation results based on inputs from the 2015-2016. As of `r Sys.Date()` these model results ar based off the erroneous diet inputs that used dry mass for prey items rather than wet mass.

```{r, echo = F}

# choose location of results for each species
## old parameters full results
dir_old_results <- "other/inputs/baseline_results_2015_2016/2015_2016_full_old.csv"
dir_new_results <- "other/inputs/baseline_results_2015_2016/2015_2016_full_new.csv"

# OLD parameters (Stewart & Ibarra)
# read in bionegetics results from old parameters
old_param_results <- read.csv(dir_old_results) %>%
  # create factors of interest from simulation name
  separate(col = Simulation, into = c("year","season","site","spp","agex","age"), 
           sep = "\\_", remove = F) %>%
  # rename day column
  rename(msg_old_param = `Specific.Growth.Rate.g.g.d`,
         wt_g_old_param = Weight.g,
         SimDay = Day) %>%
  select(SimDay,Simulation,year,site,spp,age,season,Temperature.C,msg_old_param,wt_g_old_param)

# NEW (Plumb & Moffitt)
# import simulated mass-specific growth values from new-parameters results
new_param_results <- read.csv(dir_new_results) %>%
  # add additional response or joining variables  here if needed
  # rename day column
  rename(msg_new_param = `Specific.Growth.Rate.g.g.d`,
         wt_g_new_param = Weight.g,
         SimDay = Day) %>%
  select(SimDay,Simulation,msg_new_param,wt_g_new_param )

# import table to associate Sim.Day for each season with a day of year
sim_dates_dir <- "other/inputs/baseline_results_2015_2016/sim_dates.csv"
sim_dates <- read.csv(sim_dates_dir) %>%
  transform(sim_name = as.factor(sim_name),
            Date = mdy(Date)) %>%
  mutate(doy = yday(Date)) %>%
  rename(Simulation = sim_name) %>%
  select(-X)

# join sim_dates table with results
results <- left_join(old_param_results,new_param_results, by = c("Simulation","SimDay")) %>%
  left_join(sim_dates, by = c("Simulation","SimDay")) %>%
  transform(year = as.factor(year)) %>%
  # create columns to be able to match with projected results df
  mutate(scenario = "observed",
         cmax_stat = "output") %>%
  select(-Date) 

# how many unique simulations do we have?
n_sims <- results %>%
  distinct(Simulation) %>%
  nrow() %>%
  as.numeric()

```

For unique iterations of year, season, site, fish species, and fish age we have a total of `r n_sims` simulations.

Question: do we have any 2015-2016 simulations wherein final size is smaller than start size?

```{r}
z1 <- results %>%
  group_by(Simulation) %>%
  slice(min(SimDay)) %>%
  rename(wt_start = wt_g_old_param) %>%
  select(Simulation,wt_start)

z2 <- results %>%
  group_by(Simulation) %>%
  slice(max(SimDay)) %>%
  rename(wt_end = wt_g_old_param) %>%
  select(Simulation,wt_end)

n_sims_shrink <- left_join(z1,z2) %>%
  mutate(diff = wt_end - wt_start) %>%
  arrange(diff) %>%
  filter(diff < 0) %>%
  distinct(Simulation) %>%
  nrow() %>%
  as.numeric()

rm(z1,z2)
```

There are `r n_sims_shrink` seasonal simulations in which end size is less than start size.


next: lets get an output df from the previous chapter and use that to join to compare measured size against modeled size
