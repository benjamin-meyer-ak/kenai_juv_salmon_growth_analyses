# Future Scenarios Bioenergetics Model Runs

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache=TRUE, collapse=TRUE)
```

```{r, echo = F}
# Clear environment
rm(list=ls())

#require packages
library(tidyverse)
library(lubridate)
library(xfun)
library(plotrix)
library(readxl)
library(anytime)

# variant theme WITHOUT angled x-axis labels
bm_theme_1 <- theme(plot.title = element_text(size= 26, face = "bold"),        # plot title
                  axis.text.x = element_text(size=10),
                  axis.text.y = element_text(size=10),                       # x axis text
                  axis.title.x = element_text(size=16),                      # x axis title
                  axis.title.y = element_text(size=16)) +                    # y axis title
  theme(strip.text = element_text(face="bold", size=12),
        strip.background = element_rect(fill="lightblue", 
                                        colour="black",size=1)) 

```

Choose destination for simulation input files created in this script
```{r}
# choose destination for sim input files to be created
sim_filepath <- paste0("other/FB4_1.1.3_projected.1/all_projected_sims")

```


## Introduction

In the previous chapter, we generated the input data structures needed to run bioenergetics simulations on each of our fish cohorts from observed 2015-2016 field data. We also generqted model outputs using the 2015-2016 data.

Here, we will use the 2015-2016 data, along with projected air temperature data, to generate and execute bioenergetics model runs for a suite of future climate and diet scenarios.

### Projected Temperatures

Projected air temperatures for 2010-2019, 2030-2039, and 2060-2069 from the RCP 6.0 and 8.5 climate scenarios were extracted from each field site, as monthly decadal means. Projected air temperatures were translated to projected water temperatures by applying linear air-water relationships for each site based on weekly averages from 2015-2016 field data.

```{r, echo = F}
embed_file("other/inputs/downloads/raster_extract_ml_v3.Rmd",text = "Download draft of methods used to generate projected water temperatures")

```

```{r, echo = F}
embed_file("other/inputs/temperature/projected_temps.csv",text = "Download projected air and water temperatures")
```


### Diet scenarios 

We used the results of bioenergetics simulations based on 2015-2016 field data to generate "high consumption" and "low consumption" diet scenarios. We created simulations of -20%, baseline, and +20% of the estimated proportion of maximum consumption (p-value).


### Preparation of inputs for projected scenario simulations

Here, we will re-run nearly the entire procedure described in the previous chapter, but with projected instead of observed temperatures, and consumption scenarios of +/-20% p-value. The design file will be prepared to fit to a p-value instead of a final weight.

6/19/2022 ::: working here - we need to adapt this to match data inputs from chapter 1 where appropriate.

<details>

<summary>

*Show/Hide Code used to generate projected growth simulations*

</summary>


<br>

Choose destination for simulation input files created in this script
```{r}
# choose destination for sim input files to be created
sim_filepath <- "kenai_juv_salmon_growth_analyses/other/FB4_1.1.3_projected"

```


#### Temperature

Import projected daily mean temperatures for each site/year from google sheet output of "air_water_temps.Rmd"

```{r}

# 6/19/2022 - from a coding standpoint, re-running all this old code is an atrocious choice. Proceeding as such due to time constraints.


# import daily mean site temperatures
## we will use this structure to match to our projected temps, removing 2015-2016 temperatures later
daily_mean_temps <- read.csv("other/inputs/temperature/observed_water_temp/daily_temp_metrics.csv") %>%
  select(Stream_Name,Site,year,Date,doy,daily_avg_temp) %>% 
  rename(site = Site) %>%
  transform(year = as.factor(year)) %>%
  mutate(month = month(Date)) 

# Projected temperatures are at scale of month/decade/site.  We need to get a projected temp associated w/ each SimDay in present-day sim structure.

# read in projected water temperatures
projected_temps <- read.csv("other/inputs/temperature/projected_temps.csv") %>%
  # remove unneeded columns
  select(-X,-proj_air_Temp_C,-sens_slope,-sens_int,-r_sq,-n_weeks) %>%
  # fix scenario name column
  transform(scenario = str_replace(scenario,"sres","")) %>%
  # select
  select(scenario,decade,month,Site,proj_h2o_Temp_C) %>%
  rename(site = Site) %>%
  # calculate decadal averages for each site/month
  group_by(scenario,decade,site,month) %>%
  summarise(proj_dec_h2o_Temp = mean(proj_h2o_Temp_C),
            h2o_se = std.error(proj_h2o_Temp_C, na.rm = T)) %>%
  mutate(scenario_period = paste0(scenario,"_",decade))


# join projected temperatures to dataframe used for present-day temps
daily_mean_temps <- left_join(daily_mean_temps,projected_temps,by = c("site","month")) %>%
  # replace present-day temperatures with future projected temperatures
  select(-daily_avg_temp) %>%
  select(scenario_period,Stream_Name,site,year,Date,doy,proj_dec_h2o_Temp) %>%
  rename(daily_avg_temp = proj_dec_h2o_Temp)

# temperature dataframe now contains daily inputs from projected/downsacaled temperatures!

# what is the final day with daily air temperature inputs common  to all sites among both years?
z <- daily_mean_temps %>%
  group_by(site,year) %>%
  summarise(min_date = min(Date),
            max_date = max(Date)) %>%
  ungroup() %>%
  summarise(max_mindate = max(min_date),
            min_maxdate = min(max_date))

# julian day with air tempeature inputs common to all sites among both years
yday(z$max_mindate)
yday(z$min_maxdate)

```

Day 232 (Aug 20th) is the latest date with air temperature inputs common to both years

<br>

#### Diet Inputs

For scenarios involving future projections, we will use the same wet masses of prey items calculated in the previous chapter (2015-2016 growth simulations). 


```{r}
# download wet mass of each prey item assigned to each fish
dir <- "other/outputs/fish_prey_wet_mass.csv"
diet <- read.csv(dir)
embed_file(dir,text = "Download full table of prey wet mass from each fish")
```

<br>

### Define scale of diet and growth input pooling/segregation

We will group fish growth simulation inputs at the space/time scale of:

-   Individual River (pool data among sites within each river)

-   Species (segregate Chinook vs coho)

-   Fish age (age 0 vs 1)


Diet data is pooled at the scale of spp, age, watershed.

For example, an individual cohort of fish could be "Beaver Creek Age 1 Coho" for each simulation (diet/climate)

<details>

<summary>

*Show/Hide Code*

</summary>

```{r}

#create sum of pooled prey DM for each prey category by fish species and sample event 
wm_sum_by_event <- diet %>%
  
  # choose level of diet input segregation here
  group_by(
    #year,
    #Hydrologic.Segment,
    #season,
    river,
    spp,
    PreyCategory_ED,
    age) %>%
  summarise(sum(wm_mg)) %>%
  rename(wm_sum =`sum(wm_mg)`) %>%
  spread(PreyCategory_ED,wm_sum) %>%
  rowwise() %>%
  # create column for summed dry mass of all prey categories
  mutate(wm_tot = sum(InvertTerrestrial,
                      InvertAquatic_AqOrigin,
                      InvertTerrestrial_AqOrigin,
                      FishEggs,    
                      SalmonEggs, 
                      na.rm = TRUE)) %>%
  mutate(FishEggs = FishEggs/wm_tot,
         # change prey quantities to relative proportions by category
         InvertAquatic_AqOrigin = InvertAquatic_AqOrigin/wm_tot,  
         InvertTerrestrial = InvertTerrestrial/wm_tot,
         InvertTerrestrial_AqOrigin = InvertTerrestrial_AqOrigin/wm_tot,
         SalmonEggs = SalmonEggs/wm_tot) %>%
  rename(Stream_Name = river) %>%
  select(-wm_tot) %>%
  # show only 3 decimal places
  mutate(across(where(is.numeric), round, 3))

```

</details>

<br>

```{r, echo = F}
write.csv(wm_sum_by_event,"other/outputs/diet/wet_mass_diet_proportions.csv",row.names = F)

embed_file("other/outputs/diet/wet_mass_diet_proportions.csv",text = "Download wet mass diet proportions by prey category for each fish cohort.")
```

<br>


##### d.) Define temporal extents of simulations
```{r}
# Define temporal extents of proposed simulations

# NOTE 1/22/18: this code also exists as a script at "/Users/bmeyer/Google Drive/Thesis/R Analysis/Thesis Analyses R Project/Overall_scripts_2015_2016/sampling_periods.R".  Attempted to just source("\path") this script in to the markdown document but, 'source' function prevents knitting through markdown for some reason.  

# define locations of needed spreadsheets w/ diet data
SCTC2015 <- "other/inputs/diet_size_other/2015 EPSCoR SCTC.xlsx"
SCTC2016 <- "other/inputs/diet_size_other/2016_EPSCoR_Aquatic_Ecology_Database.xlsx"

############
#
# 2015
#
###########

#read in specific worksheet containing fishing data
effort2015 <- read_excel(SCTC2015, sheet ="B Fishing Data",skip=2) %>%
  #rename needed columns  
  rename(site.id=Site_ID,
         sample.event=Sample_Event) %>%
  
  #select desired columns
  select(site.id,Reach,River,sample.event,sample.event.num,deploy_dt,collect_dt) %>%
  
  #filter out blanks
  filter(!is.na(sample.event)) %>%
  
  # transform columns to desired classes
  transform(site.id=as.factor(site.id),
            sample.event=as.factor(sample.event),
            sample.event.num=as.factor(sample.event.num)) 


###################
#
# 2016
#
###################

#read in specific worksheet containing fishing data
effort2016 <- read_excel(SCTC2016, sheet = "B Fishing Data",skip=2) %>%
  
  #rename needed columns  
  rename(site.id=Site_ID,
         sample.event=Sample_Event) %>%
  
  #select desired columns
  select(site.id,Reach,River,sample.event,sample.event.num,deploy_dt,collect_dt) %>%
  
  #filter our blanks
  filter(!is.na(sample.event)) %>%
  
  # transform columns to desired classes
  transform(site.id=as.factor(site.id),
            sample.event=as.factor(sample.event),
            sample.event.num=as.factor(sample.event.num)) 


# bind 2015 & 2016 data; format datetimes
effort <- bind_rows(effort2015,effort2016) %>%
  transform(collect_dt = anytime(collect_dt),
            deploy_dt = anytime(deploy_dt)) %>%
  mutate(year = year(collect_dt)) %>%
  mutate(site = paste(Reach,River)) %>%
  filter(site != "Upper Ptarmigan Creek")

rm(effort2015,effort2016)
```

<br> HERE

B.) Simulation extents segregated by site
```{r}

# Define Temporal Extents of proposed simulations 

# "Simulation" temporal extent 
# Time period from first date of each season to first date of following season
## (for projected sims, earliest sample date between both years to latest sample date)

# prepare data to tibble form
sim_extents_by_site <- effort %>% 
  group_by(River,site, year,sample.event,sample.event.num) %>% 
  nest() %>% 
  mutate(season.start = map_dbl(data, ~min(.$deploy_dt)),
         season.end = map_dbl(data, ~min(.$deploy_dt))
         ) %>%
  transform(season.start = anytime(season.start),
            season.end = anytime(season.end)) %>%
  arrange(site,year,sample.event) 

# prepare data such that end of one season is beginning of next
t15 <- sim_extents_by_site %>% 
  filter(year == 2015) %>%
  mutate(season.end_x = lead(season.end)) %>%
  select(-season.end) %>%
  arrange(River,year,sample.event)

t16 <- sim_extents_by_site %>% 
  filter(year == 2016) %>%
  mutate(season.end_x = lead(season.end)) %>%
  select(-season.end) %>%
  arrange(River,year,sample.event)

# prepare data such that final season of each year has duration of 30 days.
# 2015 had 3 seasons, 2016 had 4 seasons.

t_end15 <- t15 %>%
  filter(sample.event.num == 3) %>%
  mutate(season.end = season.start + days(30)) %>%
  select(-season.end_x)

t_end16 <- t16 %>%
  filter(sample.event.num == 4) %>%
  mutate(season.end = season.start + days(30)) %>%
  select(-season.end_x)

t_end15_1 <- t15 %>%
  filter(sample.event.num != 3) %>%
  rename(season.end = season.end_x)

t_end16_1 <- t16 %>%
  filter(sample.event.num != 4) %>%
  rename(season.end = season.end_x) %>%
  filter(sample.event != "MPC-2016-3")

# NOTE: there was no 4th visit in 2016 to Middle Ptarmigan Creek due to logistical reasons and low CPUE.  Final season temporal extent is manually assigned here
mpc_2016_3 <- t16 %>%
  filter(sample.event == "MPC-2016-3") %>%
  select(-season.end_x) %>%
  mutate(season.end = season.start + days(30))

# final version of simulation extents
sim_extents_by_site <- bind_rows(t_end15_1,t_end15,t_end16_1,t_end16,mpc_2016_3) %>%
  rename(Stream_Name = River,
         sim.start = season.start,
         sim.end = season.end) %>%
  transform(year = as.factor(year)) %>%
  mutate(season = fct_recode(as.factor(sample.event.num), #code sampling events as seasons
                             "Early Summer"="1", 
                             "Mid-Summer" = "2",
                             "Late Summer" ="3",
                             "Fall" = "4")) %>%
  select(-data) %>%
  mutate(days = round(sim.end - sim.start))

# remove temporary objects
rm(t_end15,t_end15_1,t_end16,t_end16_1,mpc_2016_3)

# 6/4/19 edits: get duration of days from earliest to latest doy site visits
sim_extents_by_stream1 <- sim_extents_by_site %>%
  group_by(Stream_Name,site) %>%
  mutate(sim.start.doy = yday(sim.start),
         sim.end.doy = yday(sim.end)) %>%
  summarise(sim.start1 = min(sim.start.doy),
            sim.end1 = max(sim.end.doy)) %>%
  mutate(days = sim.end1 - sim.start1) %>%
  rename(sim.start = sim.start1,
         sim.end = sim.end1)

```

<br>

```{r}
# match temporal extent of simulated diet proportion data to simulation date if it exists. 
diet_prop_seasons <- left_join(wm_sum_by_event,sim_extents_by_stream1) %>%
  #select(-`<NA>`) %>%
  transform(days = as.double(days))

```

<br>

We want each sim to be the duration of earliest site visit to latest site visit, and for diet props to be the mean of all sample events for that drainage by spp/age.

```{r sim.day munging}

# extend diet props down length of season
# diet proportions are static throughout season for now, can consider other approaches later
sim_diet_days <- diet_prop_seasons[rep(seq_len(nrow(diet_prop_seasons)),diet_prop_seasons[,"days"]), ]

# add a row # ("SimDay") per row within each desired sim group, 
sim_diet_days <- sim_diet_days %>%
  mutate(sim_name = paste0(site,"_",
                           spp,"_",
                           "Age","_",
                           age)) %>%
  group_by(sim_name) %>%
  mutate(SimDay = row_number()) 

```

<br>



```{r, echo = F}
# In the following chapter, we will need a way to match up the generic sim temporal extent data (Day 1 --> Day Y) with the actual julian days (Day X --> Day Y). Here we will export such a csv table for later use.

sim_days_tbl <- sim_diet_days %>%
  select(sim.start,sim.end,sim_name,SimDay)
write.csv(sim_days_tbl,"other/outputs/sim_days_tbl.csv", row.names = F)

```




```{r}
# join daily mean temperatures with diet proportions

# 1.) create sim_diet_days object with identical diet props for each iteration of scenario_decade

sim_diet_days_2030_rcp60 <- sim_diet_days %>%
  mutate(scenario_period = "rcp60_2030_2039")

sim_diet_days_2030_rcp85 <- sim_diet_days %>%
  mutate(scenario_period = "rcp85_2030_2039")

sim_diet_days_2060_rcp60 <- sim_diet_days %>%
  mutate(scenario_period = "rcp60_2060_2069")

sim_diet_days_2060_rcp85 <- sim_diet_days %>%
  mutate(scenario_period = "rcp85_2060_2069")

sim_diet_days_2010_rcp60 <- sim_diet_days %>%
  mutate(scenario_period = "rcp60_2010_2019")

sim_diet_days_2010_rcp85 <- sim_diet_days %>%
  mutate(scenario_period = "rcp85_2010_2019")

sim_diet_days <- bind_rows(sim_diet_days_2030_rcp60,
               sim_diet_days_2030_rcp85,
               sim_diet_days_2060_rcp60,
               sim_diet_days_2060_rcp85,
               sim_diet_days_2010_rcp60,
               sim_diet_days_2010_rcp85) %>%
  # create doy column
  mutate(doy = sim.start + SimDay)


# we only need one year of the dataframe "daily_mean_temps"
daily_mean_temps <- daily_mean_temps %>%
  mutate(year = year(Date)) %>%
  filter(year == 2016) %>%
  select(-year) %>%
  mutate_all(funs(str_replace(., "_2010", "_2010_2019"))) %>%
  mutate_all(funs(str_replace(., "_2030", "_2030_2039"))) %>%
  mutate_all(funs(str_replace(., "_2060", "_2060_2069"))) %>%
  transform(doy = as.numeric(doy))


```




```{r}

# join downscaled/projected temps to diet data frame

## first: prepare projected temperatures to be joined by MONTH instead of day, so that temporal extent of temps and diet data can match
daily_mean_temps %<>%
  mutate(month = month(Date)) %>%
  select(-Date,-doy) %>%
  distinct()

## next: prep sim_diet_days to be joined to projected temps by month
## we need sim_diet_days to retain a date so we can extract a month
## create month column
library(magrittr)

sim_diet_days %<>%
  mutate(date = as.Date(doy,origin = as.Date("2015-01-01")),
         month = month(date),
         doy = yday(date)) %>%
  select(-doy,-date)

## join diet data and projected temp data
sim_diet_days  <- left_join(sim_diet_days,daily_mean_temps, by=c("site",
                                                                 "scenario_period",
                                                                 "month",
                                                                 "Stream_Name")) %>%
  rename(avg_temp = daily_avg_temp) %>%
  # eliminate instances where paired diet data does not exist with temp data
  filter(!is.na(avg_temp))

# remove extraneous dfs
rm(sim_diet_days_2030_rcp60, sim_diet_days_2030_rcp85, sim_diet_days_2060_rcp60, sim_diet_days_2060_rcp85, sim_diet_days_2010_rcp60, sim_diet_days_2010_rcp85)

```


On 6/24/2022 when attempting to use FB4 v1.1.3 to run projected simulations, the app will not proceed after simulation #18. The reason appears to be that within some main input folders, there is a mismatch between the extent of diet sim data and temp sim data. We want to get these two temporal extents to match... 

These instances occur because in some cases observed water/air temp data did not extend in to late summer, whereas projected data can.

Modified/resolved 6/24/2022, joined diet to data by month instead of day.

```{r, echo = F}
# export table of diet proportions for each cohort for table 2 in ms
diet_prop_tbl <- sim_diet_days %>%
  ungroup() %>%
  filter(age != 2) %>%
  select(Stream_Name,spp,age,
         FishEggs,InvertAquatic_AqOrigin,
         InvertTerrestrial,InvertTerrestrial_AqOrigin,
         SalmonEggs) %>%
  distinct()

# export table
write.csv(diet_prop_tbl,"other/outputs/diet_props_tbl2.csv",row.names = F)
```




```{r finalize format of sim_diet_days }

 # arrange and rename columns to format identical as in "InputFileTemplate" for bioenergetics modeling
sim_diet_days <- sim_diet_days %>%
  rename(diet1 = FishEggs,
         diet2 = InvertAquatic_AqOrigin,
         diet3 = InvertTerrestrial,
         diet4 = InvertTerrestrial_AqOrigin,
         diet5 = SalmonEggs,
         Temp = avg_temp) %>%
  # add in blank columns 7-10 to match InputFileTemplate format
  mutate(diet6 = 0,
         diet7 = 0,
         diet8 = 0,
         diet9 = 0,
         diet10 = 0) %>%
  # select desired columns  
  select(SimDay,Temp,
         contains("Diet"),
         sim_name,spp,scenario_period) %>%
  # ensure that list of dataframes and list of dataframe names match up order in next step
  arrange(sim_name) %>%
  # round decimals to two digits
  mutate_if(is.numeric, funs(round(., 1))) %>%
  # filter out simulation days with no temperature data; trim lengths of sims to days w/ sims
  filter(!is.na(Temp)) 
  
#replace all NA's with 0's
sim_diet_days[is.na(sim_diet_days)] <- 0

# eliminate simulations where diet inputs are all zeros (not possible to run a simulation)
# a.) create dataframe that conatins sim names with zero diet content
#zero_sims <- sim_diet_days %>%
# select(-spp) %>%
#  group_by(sim_name) %>% 
#  #summarise_each(funs(sum)) %>%
#  # sum across columns with diet proportions
#  mutate(sum = select(diet1,diet2) %>% apply(1, sum, na.rm=TRUE))
#  mutate(diet_prop_sum = rowSums(diet1,diet2,diet3,diet4,diet5,diet6,diet7,diet8,diet9,diet10, na.rm = T)) %>%
#  select(sim_name, diet_prop_sum) %>%
  # filter to create dataframe of simulations with zero diet content
#  filter(diet_prop_sum == 0)



# export names of simulations with zero diet mass to google sheet for later reference

# code below hastagged out b/c there are already no samples included w/ zero diet mass

## remove any existing googlesheet resulting from previous runs of this script
#zero_sims_gs <- gs_title("zero_diet_mass_sims")
#gs_delete(zero_sims_gs)
## write new sheet with data
#gs_new("zero_diet_mass_sims", input = zero_sims)

# b.) use above table to remove simulatins with zero diet content
#sim_diet_days <- anti_join(sim_diet_days,zero_sims)

# correct SimDay assignment column...
sim_diet_days <- sim_diet_days %>%
  select(-SimDay) %>%
  group_by(sim_name,scenario_period,spp) %>%
  mutate(SimDay = row_number()) %>%
  # arrange columns in desired order
    select(SimDay,Temp,diet1,diet2,diet3,diet4,diet5,diet6,diet7,diet8,diet9,diet10,sim_name,spp,scenario_period)

```

```{r eval = FALSE}
# How many simulations included?
#(n_sims <- nrow(sim_size_inputs_list))

```
There are `r n_sims` distinct simulations included in bioenergetics modeling efforts.


Alter sim names to specify decade, scenario, and diet inputs of simulations
```{r}
# 
sim_diet_days <- sim_diet_days %>%
  ungroup() %>%
  mutate(sim_name = paste0(scenario_period,"_",sim_name)) %>%
  select(-scenario_period) 

```


<br>

a.) water temperature csv file export prep

```{r eval = FALSE}

# export water temperature csv files

## select desired variables
watertemps <- sim_diet_days %>%
  select(SimDay,Temp,sim_name,spp) %>%
  rename(day = SimDay,
         temperature = Temp) %>%
#recreate grouping variable
  group_by(sim_name)

# create individual dataframes for each species
watertemps_coho <- watertemps %>%
  filter(spp == "Coho") %>%
  select(-spp)

watertemps_chnk <- watertemps %>%
  filter(spp == "Chinook") %>%
  select(-spp)

# split up all data in to lists of individual simulations by year, river, species, age, and season
watertemps_list_coho <- split.data.frame(watertemps_coho, watertemps_coho$sim_name)
watertemps_list_chnk <- split.data.frame(watertemps_chnk, watertemps_chnk$sim_name)

# remove column containing name of simulation from all objects in list
watertemps_list_coho <- lapply(watertemps_list_coho, function(x) x[!(names(x) %in% c("sim_name"))])
watertemps_list_chnk <- lapply(watertemps_list_chnk, function(x) x[!(names(x) %in% c("sim_name"))])

```

<br>

b.) diet proportion csv file export prep
```{r}

# export diet proportion csv files

## select desired variables
dietprops <- sim_diet_days %>%
  select(-Temp) %>%
  rename(day = SimDay) %>%
#recreate grouping variable
  group_by(sim_name)

# create individual dataframes for each species
dietprops_coho <- dietprops %>%
  filter(spp == "Coho") %>%
  select(-spp)

dietprops_chnk <- dietprops %>%
  filter(spp == "Chinook") %>%
  select(-spp)

# split up all data in to lists of individual simulations by year, river, species, age, and season
dietprops_list_coho <- split.data.frame(dietprops_coho, dietprops_coho$sim_name)
dietprops_list_chnk <- split.data.frame(dietprops_chnk, dietprops_chnk$sim_name)

# remove column containing name of simulation from all objects in list
dietprops_list_coho <- lapply(dietprops_list_coho, function(x) x[!(names(x) %in% c("sim_name"))])
dietprops_list_chnk <- lapply(dietprops_list_chnk, function(x) x[!(names(x) %in% c("sim_name"))])

```

<br>

```{r}

# eliminate overall existing directory and contents if applicable
unlink(sim_filepath, recursive = T)

# create overall directory destination for input files
dir.create(sim_filepath)

# name directory paths
chnk_dir <- paste0(sim_filepath,"/","chnk","/")
coho_dir <- paste0(sim_filepath,"/","coho","/")

# create directory destinations for input files
dir.create(chnk_dir)
dir.create(coho_dir)

```

<br>

# export chinook diet proportions to csv files
```{r}

# get names of all simulations in a list
dietprops_names_chnk <- dietprops_chnk %>%
  select(sim_name) %>%
  distinct()
dietprops_names_chnk <- as.list(dietprops_names_chnk)

# create sub-directory for each simulation
## get simulation names
### chinook
dietprops_names_chnk <- as.data.frame(dietprops_names_chnk) %>%
  mutate(folder_dir = paste0(chnk_dir,sim_name),
         diet_csv_dir1 = paste0(chnk_dir,"Diet_prop_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Diet_prop_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Diet_prop",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    dietprops_names_chnk$folder_dir)

# write diet proportion csv files
mapply(write.table,row.names = F, sep=",",
       dietprops_list_chnk, file = paste0(chnk_dir,"Diet_prop","_", names(dietprops_list_chnk),".csv"))

# move output files from chnk directory to individual simulation folders
Map(file.rename,
    from = dietprops_names_chnk$diet_csv_dir1,
    to = dietprops_names_chnk$diet_csv_dir2)

# rename each diet proportion csv file as "Diet_prop" to prepare for input to FB4
Map(file.rename,
    from = dietprops_names_chnk$diet_csv_dir2,
    to = dietprops_names_chnk$diet_csv_dir3)

# results: "Diet_prop.csv" exists in a named folder for each simulation

```

<br>

# export chinook temperature data to csv files
```{r}

# get names of all simulations in a list
watertemps_names_chnk <- watertemps_chnk %>%
  select(sim_name) %>%
  distinct()
watertemps_names_chnk <- as.list(watertemps_names_chnk)

# create sub-directory for each simulation
## get simulation names
### chinook
watertemps_names_chnk <- as.data.frame(watertemps_names_chnk) %>%
  mutate(folder_dir = paste0(chnk_dir,sim_name),
         diet_csv_dir1 = paste0(chnk_dir,"Temperature_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Temperature_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Temperature",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    watertemps_names_chnk$folder_dir)

# write temperature csv files
mapply(write.table,row.names = F, sep=",",
       watertemps_list_chnk, file = paste0(chnk_dir,"Temperature","_", names(watertemps_list_chnk),".csv"))

# move output files from chnk directory to individual simulation folders
Map(file.rename,
    from = watertemps_names_chnk$diet_csv_dir1,
    to = watertemps_names_chnk$diet_csv_dir2)

# rename each diet proportion csv file as "Diet_prop" to prepare for input to FB4
Map(file.rename,
    from = watertemps_names_chnk$diet_csv_dir2,
    to = watertemps_names_chnk$diet_csv_dir3)

# results: "Temperature.csv" exists in a named folder for each simulation

```

<br>

# export coho diet proportions to csv files
```{r}

# get names of all simulations in a list
dietprops_names_coho <- dietprops_coho %>%
  select(sim_name) %>%
  distinct()
dietprops_names_coho <- as.list(dietprops_names_coho)

# create sub-directory for each simulation
## get simulation names
dietprops_names_coho <- as.data.frame(dietprops_names_coho) %>%
  mutate(folder_dir = paste0(coho_dir,sim_name),
         diet_csv_dir1 = paste0(coho_dir,"Diet_prop_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Diet_prop_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Diet_prop",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    dietprops_names_coho$folder_dir)

# write diet proportion csv files
mapply(write.table,row.names = F, sep=",",
       dietprops_list_coho, file = paste0(coho_dir,"Diet_prop","_", names(dietprops_list_coho),".csv"))

# move output files from coho directory to individual simulation folders
Map(file.rename,
    from = dietprops_names_coho$diet_csv_dir1,
    to = dietprops_names_coho$diet_csv_dir2)

# rename each diet proportion csv file as "Diet_prop" to prepare for input to FB4
Map(file.rename,
    from = dietprops_names_coho$diet_csv_dir2,
    to = dietprops_names_coho$diet_csv_dir3)

# results: "Diet_prop.csv" exists in a named folder for each simulation

```

<br>

# export coho temperature data to csv files
```{r}

# get names of all simulations in a list
watertemps_names_coho <- watertemps_coho %>%
  select(sim_name) %>%
  distinct()
watertemps_names_coho <- as.list(watertemps_names_coho)

# create sub-directory for each simulation
## get simulation names
watertemps_names_coho <- as.data.frame(watertemps_names_coho) %>%
  mutate(folder_dir = paste0(coho_dir,sim_name),
         diet_csv_dir1 = paste0(coho_dir,"Temperature_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Temperature_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Temperature",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    watertemps_names_coho$folder_dir)

# write diet proportion csv files
mapply(write.table,row.names = F, sep=",",
       watertemps_list_coho, file = paste0(coho_dir,"Temperature","_", names(watertemps_list_coho),".csv"))

# move output files from coho directory to individual simulation folders
Map(file.rename,
    from = watertemps_names_coho$diet_csv_dir1,
    to = watertemps_names_coho$diet_csv_dir2)

# rename each diet proportion csv file as "Diet_prop" to prepare for input to FB4
Map(file.rename,
    from = watertemps_names_coho$diet_csv_dir2,
    to = watertemps_names_coho$diet_csv_dir3)

# results: "Temperature.csv" exists in a named folder for each simulation

```

<br>

Final outcome so far: diet proportions and water temperature at scale of year/site/spp/age by day w/ water temp, stored in local directory named after the simulation

<br>

Task: include the other (constant) files necessary in each folder as is found in each "Main Inputs" folder for FB4:

-Indigestable_Prey.csv
-Pred_E.csv
-Prey_E.csv

These values remain constant for all simulations.

```{r}
# write the three constant Main Input files to local directory folder

## Indigestible prey
day <- c(1,365)
diet1 <- .03
diet2 <- .17
diet3 <- .17
diet4 <- .17
diet5 <-  .03 
diet6 <- 0
diet7 <- 0
diet8 <- 0 
diet9 <- 0
diet10 <- 0

# collate to data frame
Indigestible_Prey <- data.frame(day,diet1,diet2,diet3,diet4,diet5,
                                diet6,diet7,diet8,diet9,diet10)

# write file
dir_projected_main_inputs <- "other/FB4_1.1.3_projected.1/projected_main_inputs/"
unlink(dir_projected_main_inputs, recursive = T)
dir.create(dir_projected_main_inputs)
write.csv(Indigestible_Prey, paste0(dir_projected_main_inputs,"Indigestible_Prey.csv"), row.names = F)

  
## Pred_E.csv
predator <- 5000
# collate to data frame
Pred_E <- data.frame(day,predator)
# write file
write.csv(Pred_E, paste0(dir_projected_main_inputs,"Pred_E.csv"), row.names = F)


## Prey_E.csv
### see googlesheet "EPSCoR_SCTC_Prey_Energy_Densities"
diet1 <- 5235 # FishEggs
diet2 <- 3365 # InvertAquatic_AqOrigin
diet3 <- 5250 # InvertTerrestrial
diet4 <- 4225 # InvertTerrestrial_AqOrigin
diet5 <- 9000 # SalmonEggs
diet6 <- 0
diet7 <- 0
diet8 <- 0
diet9 <- 0
diet10 <- 0
  
Prey_E <- data.frame(day,diet1,diet2,diet3,diet4,diet5,
                     diet6,diet7,diet8,diet9,diet10)

write.csv(Prey_E, paste0(dir_projected_main_inputs,"Prey_E.csv"), row.names = F)

```


<br>

Approach: same as other csv exports; create list of dataframes and use mapply to export to folder of each individual simulation's folder

# chinook 

Indigestible_Prey.csv
```{r}
# get master copy file directory for indigestible prey
ip_dir <- "other/FB4_1.1.3_projected.1/projected_main_inputs/Indigestible_Prey.csv"

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = chnk_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Indigestible_Prey",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = ip_dir,
    to = z$sim_dir,
    overwrite = T)
  
```

<br>

Pred_E csv file export

# chinook Pred_E.csv
```{r}
# get master copy file directory for indigestible prey
pe_dir <- "other/FB4_1.1.3_projected.1/projected_main_inputs/Pred_E.csv"

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = chnk_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Pred_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = pe_dir,
    to = z$sim_dir,
    overwrite = T)
  
```

<br>

Prey_E export

# chinook Prey_E.csv
```{r}
# get master copy file directory for indigestible prey
prey_dir <- "other/FB4_1.1.3_projected.1/projected_main_inputs/Prey_E.csv"

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = chnk_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Prey_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = prey_dir,
    to = z$sim_dir,
    overwrite = T)
  
```


<br>

# coho 

Indigestible_Prey.csv
```{r results = "hide"}
# get master copy file directory for indigestible prey
#ip_dir <- already made

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = coho_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Indigestible_Prey",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = ip_dir,
    to = z$sim_dir,
    overwrite = T)
  
```

<br>

Pred_E csv file export

# coho Pred_E.csv
```{r}
# get master copy file directory for indigestible prey
#pe_dir <- already exists

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = coho_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Pred_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = pe_dir,
    to = z$sim_dir,
    overwrite = T)
  
```

<br>

Prey_E export

# coho Prey_E.csv
```{r}
# get master copy file directory for indigestible prey
#prey_dir <- already exists

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = coho_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Prey_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = prey_dir,
    to = z$sim_dir,
    overwrite = T)
  
```

<br>

Prep Initial settings single csv file for intake into Fishbioenergetics 4.1

All input files are exported to local directory at the scale of site/spp/age.  We now want to create a file of all simulations to be performed.  This will include a set fit to the mean and +/- 20% the Cmax value associated with this site/spp/age

<br>

Note: if we are going to use diet proportion inputs grouped within a watershed for projected sims, we should use that same scale of input for the 2015-2016 sims too to obtain Cmax values.  Done 7/5/19.



-Fit simulations to Cmax value for each site
a.) using mean/min/max consumption from empirical sims
b.) using mean 20% +/- Cmax values from empirical sims


<br>


<br>

b.) sim inputs for mean and  20% +/- consumption values, NEW PARAMETERS
```{r}
library(janitor)

# from manuscript: "Future salmon growth was projected from May 26th to Sept 4th. The start date was the earliest day of available fish weight data common to all sites and fieldwork years and the end date was calculated as the earliest final fish sampling event (August 6th) plus an additional 30 days to include the remaining summer season. Starting weight for each scenario simulation was the mean weight (either observed or linearly interpolated) on May 26th from the simulations of current conditions."

# import results (p-values) from 2015-2016 bioenerg output
fb4_2015_2016_output_dir <- "other/FB4_1.1.3_2015_2016.1/FB4_2015_2016_models_new_parameters.csv"

# prep
cmax_stats_pct <- read.csv(fb4_2015_2016_output_dir) %>%
  clean_names() %>%
  # mutate sim name
  rename(Simulation = run_name) %>%
  separate(Simulation, into = c("year","season","site","spp","e","age"),sep = "_") %>%
  separate(site, into = c("reach","river1","river2"), remove = F) %>%
  mutate(Stream_Name = paste(river1,river2)) %>%
  # retain needed columns
  select(spp,age,year,season,site,reach,initial_w,p_value,Stream_Name)


## calculate duration between start and end doy
min_sim_date <- yday(ymd("2015-05-26"))
max_sim_date <- yday(ymd("2015-09-04"))
sim_duration <- max_sim_date - min_sim_date

## calculate mean p-val by watershed, spp, age
mean_pvals <- cmax_stats_pct %>%
  group_by(Stream_Name,spp,age) %>%
  summarise(mean_pval = mean(p_value))

## calculate mean initial weight by age, spp, site
mean_start_w <- cmax_stats_pct %>%
  filter(season == "Early Summer") %>%
  group_by(Stream_Name,spp,age,site) %>%
  summarise(mean_init_w = mean(initial_w))

# join sim duration, mean p-vals, and start weights
init_file_dat <- left_join(mean_start_w,mean_pvals) %>%
  # retain mean p_val and calculate 20 % +/- consumption from each site, by site,spp,age
  mutate(`20plus_pval` = mean_pval*1.2,
         `20minus_pval` = mean_pval*0.8) %>%
  # reshape to long
  pivot_longer(cols = c("mean_pval","20plus_pval","20minus_pval")) %>%
  rename("consumption_scenario" = "name") %>%
  
  # specify simulation cohort
  mutate(Simulation = paste0(site,"_",spp,"_Age_",age))
  

# replicate inputs for all temperature scenarios, collate in to single dataframe
`2030_rcp60` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp60","_","2030_2039","_",Simulation))
`2030_rcp85` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp85","_","2030_2039","_",Simulation))
`2060_rcp60` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp60","_","2060_2069","_",Simulation))
`2060_rcp85` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp85","_","2060_2069","_",Simulation))
`2010_2019_rcp60` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp60","_","2010_2019","_",Simulation))
`2010_2019_rcp85` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp85","_","2010_2019","_",Simulation))
sim_size_inputs_FB4.1 <- bind_rows(`2030_rcp60`,
                                   `2030_rcp85`,
                                   `2060_rcp60`,
                                   `2060_rcp85`,
                                   `2010_2019_rcp60`,
                                   `2010_2019_rcp85`)  


# create design file

# 6/19/2022 --- first: we need to ensure that the "sim_size_inputs_v2" list of unique simulations matches the list of unique sims that we just used to generate main inputs

# get list of unique simulations for which main input files were generated
unique_sims <- data.frame(unique(sim_size_inputs_FB4.1$Simulation))
colnames(unique_sims) <- "sim"

# use the above list to subset list of length/weights for master simulation list file
#sim_size_inputs_FB4.1 <- read_excel("other/inputs/diet_size_other/sim_size_inputs_v2.xlsx",sheet = "lw_data") %>% inner_join(unique_sims)


# 6/19/2022 - there appears to still be a mismatch between the list of "main input" folder directories and the list of simulation names in the design file. Here we will work to diagnose where the mismatch lies, and rectify the two lists.


# Get list of folders in directory for each species
coho_dirs <- as.data.frame(list.dirs(path = "other/FB4_1.1.3_projected.1/all_projected_sims/coho"))
colnames(coho_dirs) <- "dir"
chnk_dirs <- as.data.frame(list.dirs(path = "other/FB4_1.1.3_projected.1/all_projected_sims/chnk"))
colnames(chnk_dirs) <- "dir"
folder_dirs <- bind_rows(coho_dirs,chnk_dirs) %>%
  clean_names() %>%
  separate(dir,sep = "/",into = c("a","b","c","d","sim")) %>%
  filter(!is.na(sim)) %>%
  select("sim") %>%
  rename("Simulation" = "sim")

# again, use the above list to subset list of length/weights for master simulation list file
sim_size_inputs_FB4.1 %<>% 
  inner_join(folder_dirs)


# create design input file for projected simulations, specifying these are results from NEW PARAMETERS (plumb & moffit 2015)
design_projected_new_parameters <- sim_size_inputs_FB4.1 %>%
  ungroup() %>%
  # mutate column with species abbreviations
  mutate(spp_v2 = case_when(
      spp == "Coho" ~ "coho",
      spp == "Chinook" ~ "chnk")) %>%
  mutate(
    NRun = row_number(),
    Run_Name = Simulation,
    Species_Num = case_when(
      spp == "Coho" ~ "22",
      spp == "Chinook" ~ "21"),
    Species_txt = case_when(
      spp == "Coho" ~ "Coho salmon (adult)",
      spp == "Chinook" ~ "Chinook salmon (adult)"),
    Initial_W = mean_init_w,
    fit.to = "p-value",
    fit.to.value = value,
    First_day = 1,
    Last_day = sim_duration,
    N_indiv = 1,
    Oxycal = 13560,
    calc.pop_mort = "FALSE",
    calc.spawn = "FALSE",
    calc.nut = "FALSE",
    calc.contaminant = "FALSE",
    Init_pred_conc = "NA",
    contam_eq = "NA",
    T_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Temperature.csv"),
    Diet_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Diet_prop.csv"),
    Prey_E_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Prey_E.csv"),
    Indigest_Prey_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Indigestible_Prey.csv"),
    Pred_E_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Pred_E.csv"),
    Mort_File = "NA",
    Reprod_File = "NA",
    Contam_Prey_C_File = "NA",
    Contam_assim_File = "NA",
    Contam_TE_File = "NA",
    Phos_Ae_File = "NA",
    Phos_Co_Pred_File = "NA",
    Phos_Co_Prey_File = "NA",
    Nit_Ae_File = "NA",
    Nit_Co_Pred_File = "NA",
    Nit_Co_Prey_File = "NA",
    FB4_Log_File = "FB4_projected_models.csv",
    .keep = "unused")

# rename simulations names to include info about diet scenarios
design_projected_new_parameters %<>%
  mutate(Run_Name = paste0(consumption_scenario,"_",Run_Name))


# select final column names for input file
# get all column names design file example
design_colnames <- read.csv("other/FB4_1.1.3_2015_2016.1/FB4_Design_Bluegill_1.csv") %>% colnames()

# select from subset of column in example input template
 design_projected_new_parameters %<>%
   ungroup() %>%
  select(one_of(design_colnames))


## save input csv to local directory
# name directory location
input_csv_dir <- "other/FB4_1.1.3_projected.1/design_projected_new_parameters.csv"

# remove any previous output versions
file.remove(input_csv_dir)

# write new csv file
write.csv(design_projected_new_parameters, input_csv_dir, row.names = F)

# 6/19/2022 - app produces output in "FB4_projected_models.csv"
```

<br>

c.) sim inputs for mean and  20% +/- consumption values, OLD PARAMETERS
```{r}

# import results (p-values) from 2015-2016 bioenerg output
fb4_2015_2016_output_dir <- "other/FB4_1.1.3_2015_2016.1/FB4_2015_2016_models_old_parameters.csv"

# prep
cmax_stats_pct <- read.csv(fb4_2015_2016_output_dir) %>%
  clean_names() %>%
  # mutate sim name
  rename(Simulation = run_name) %>%
  separate(Simulation, into = c("year","season","site","spp","e","age"),sep = "_") %>%
  separate(site, into = c("reach","river1","river2"), remove = F) %>%
  mutate(Stream_Name = paste(river1,river2)) %>%
  # retain needed columns
  select(spp,age,year,season,site,reach,initial_w,p_value,Stream_Name)


## calculate mean p-val by watershed, spp, age
mean_pvals <- cmax_stats_pct %>%
  group_by(Stream_Name,spp,age) %>%
  summarise(mean_pval = mean(p_value))

## calculate mean initial weight by age, spp, site
mean_start_w <- cmax_stats_pct %>%
  filter(season == "Early Summer") %>%
  group_by(Stream_Name,spp,age,site) %>%
  summarise(mean_init_w = mean(initial_w))

# join sim duration, mean p-vals, and start weights
init_file_dat <- left_join(mean_start_w,mean_pvals) %>%
  # retain mean p_val and calculate 20 % +/- consumption from each site, by site,spp,age
  mutate(`20plus_pval` = mean_pval*1.2,
         `20minus_pval` = mean_pval*0.8) %>%
  # reshape to long
  pivot_longer(cols = c("mean_pval","20plus_pval","20minus_pval")) %>%
  rename("consumption_scenario" = "name") %>%
  
  # specify simulation cohort
  mutate(Simulation = paste0(site,"_",spp,"_Age_",age))
  

# replicate inputs for all temperature scenarios, collate in to single dataframe
`2030_rcp60` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp60","_","2030_2039","_",Simulation))
`2030_rcp85` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp85","_","2030_2039","_",Simulation))
`2060_rcp60` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp60","_","2060_2069","_",Simulation))
`2060_rcp85` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp85","_","2060_2069","_",Simulation))
`2010_2019_rcp60` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp60","_","2010_2019","_",Simulation))
`2010_2019_rcp85` <- init_file_dat %>%
  mutate(Simulation = paste0("rcp85","_","2010_2019","_",Simulation))
sim_size_inputs_FB4.1 <- bind_rows(`2030_rcp60`,
                                   `2030_rcp85`,
                                   `2060_rcp60`,
                                   `2060_rcp85`,
                                   `2010_2019_rcp60`,
                                   `2010_2019_rcp85`)  


# create design file

# 6/19/2022 --- first: we need to ensure that the "sim_size_inputs_v2" list of unique simulations matches the list of unique sims that we just used to generate main inputs

# get list of unique simulations for which main input files were generated
unique_sims <- data.frame(unique(sim_size_inputs_FB4.1$Simulation))
colnames(unique_sims) <- "sim"

# use the above list to subset list of length/weights for master simulation list file
#sim_size_inputs_FB4.1 <- read_excel("other/inputs/diet_size_other/sim_size_inputs_v2.xlsx",sheet = "lw_data") %>% inner_join(unique_sims)


# 6/19/2022 - there appears to still be a mismatch between the list of "main input" folder directories and the list of simulation names in the design file. Here we will work to diagnose where the mismatch lies, and rectify the two lists.


# Get list of folders in directory for each species
coho_dirs <- as.data.frame(list.dirs(path = "other/FB4_1.1.3_projected.1/all_projected_sims/coho"))
colnames(coho_dirs) <- "dir"
chnk_dirs <- as.data.frame(list.dirs(path = "other/FB4_1.1.3_projected.1/all_projected_sims/chnk"))
colnames(chnk_dirs) <- "dir"
folder_dirs <- bind_rows(coho_dirs,chnk_dirs) %>%
  clean_names() %>%
  separate(dir,sep = "/",into = c("a","b","c","d","sim")) %>%
  filter(!is.na(sim)) %>%
  select("sim") %>%
  rename("Simulation" = "sim")

# again, use the above list to subset list of length/weights for master simulation list file
sim_size_inputs_FB4.1 %<>% 
  inner_join(folder_dirs)


# create design input file for projected simulations, specifying these are results from OLD PARAMETERS (stewart & ibarra 199?)
design_projected_old_parameters <- sim_size_inputs_FB4.1 %>%
  ungroup() %>%
  # mutate column with species abbreviations
  mutate(spp_v2 = case_when(
      spp == "Coho" ~ "coho",
      spp == "Chinook" ~ "chnk")) %>%
  mutate(
    NRun = row_number(),
    Run_Name = Simulation,
    Species_Num = case_when(
      spp == "Coho" ~ "22",
      spp == "Chinook" ~ "21"),
    Species_txt = case_when(
      spp == "Coho" ~ "Coho salmon (adult)",
      spp == "Chinook" ~ "Chinook salmon (adult)"),
    Initial_W = mean_init_w,
    fit.to = "p-value",
    fit.to.value = value,
    First_day = 1,
    Last_day = sim_duration,
    N_indiv = 1,
    Oxycal = 13560,
    calc.pop_mort = "FALSE",
    calc.spawn = "FALSE",
    calc.nut = "FALSE",
    calc.contaminant = "FALSE",
    Init_pred_conc = "NA",
    contam_eq = "NA",
    T_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Temperature.csv"),
    Diet_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Diet_prop.csv"),
    Prey_E_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Prey_E.csv"),
    Indigest_Prey_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Indigestible_Prey.csv"),
    Pred_E_File = paste0("all_projected_sims/",spp_v2,"/",Run_Name,"/","Pred_E.csv"),
    Mort_File = "NA",
    Reprod_File = "NA",
    Contam_Prey_C_File = "NA",
    Contam_assim_File = "NA",
    Contam_TE_File = "NA",
    Phos_Ae_File = "NA",
    Phos_Co_Pred_File = "NA",
    Phos_Co_Prey_File = "NA",
    Nit_Ae_File = "NA",
    Nit_Co_Pred_File = "NA",
    Nit_Co_Prey_File = "NA",
    FB4_Log_File = "FB4_projected_models.csv",
    .keep = "unused")

# rename simulations names to include info about diet scenarios
design_projected_old_parameters %<>%
  mutate(Run_Name = paste0(consumption_scenario,"_",Run_Name))



# select final column names for input file
# get all column names design file example
design_colnames <- read.csv("other/FB4_1.1.3_2015_2016.1/FB4_Design_Bluegill_1.csv") %>% colnames()

# select from subset of column in example input template
 design_projected_old_parameters %<>%
   ungroup() %>%
  select(one_of(design_colnames))


## save input csv to local directory
# name directory location
input_csv_dir <- "other/FB4_1.1.3_projected.1/design_projected_old_parameters.csv"

# remove any previous output versions
file.remove(input_csv_dir)

# write new csv file
write.csv(design_projected_old_parameters, input_csv_dir, row.names = F)

# 6/19/2022 - app produces output in "FB4_projected_models.csv"
```

final result: single input file for FB4.1 listing all the sims, including the % +/- the mean Cmax of each site/spp/age.






working here ::: adapting create_biol_input_v3.rmd from line 873 on down to this new script...


