# 2015-2016 Bioenergetics Model Runs

```{r, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, cache=TRUE, collapse=TRUE)
```

```{r initialize script, echo = F}
# Clear environment
rm(list=ls())

#require packages
library(tidyverse)
library(forcats)
library(rmarkdown)
library(lubridate)
library(anytime)
library(plotrix)
library(readxl)
library(xfun)
library(janitor)
library(kableExtra)
library(magrittr)
suppressMessages(library(dplyr))
#detach("package:MASS", unload=TRUE) #pkg masks some dplyr functions

select <- dplyr::select

# This section generates and saves txt files to a local project directory that contain information needed to run bioenergetics simulations using present day (2015-2016) data.  The list of txt files should be identical to that listed in the file "sim_size_inputs". The script was originally designed to create inputs for a script passed down from Erik Schoen and Adam Hansen.  Version 2.0 is designed to create inputs to be used manually in Fishbioenergetics 4.0.

# 6/12/19: this script is being adjusted to change the scale at which diet proportion inputs are grouped.  Some simulations were producing unrealistic results due to high proportion of salmon eggs.  Since gastric lavage is just a snapshot this does not produce a realistic daily input.  S0, as of 6/12/19 diet proportions are being segregated by species, age, and drainage by not by year, site, or season.  Whew!

```

## Generate inputs for bioenergetics modeling, 2015-2016 inputs

The following files are required as inputs for an individual growth simulation in Fishbioenergetics 4.0:

1.  Temperature.csv; cols: day (DOY), temperature (C)

2.  Predator.csv; cols: day (DOY), predator (j/g)

3.  Prey.csv; cols: day (DOY), diet1, diet2, diet3... (energy densities)

4.  Indigestible_Prey.csv, cols: day (DOY), diet1, diet2, diet3... (proportion indigestable)

5.  Diet_Prop.csv; cols: day (DOY), diet1, diet2, diet3... (diet proportions)

In this section, we will generate input files using observed data from the 2015 and 2016 field seasons for individual cohorts (individual year, river, species, and age; e.g. "2015 Beaver Creek Age 1 Coho").

<br>

### Temperature

We used daily mean water temperature inputs from each site as model inputs.

<details>

<summary>

*Show/Hide Code used prepare water temperature data inputs from 2015-2016 field observations*

</summary>

```{r}
# import daily mean temperature summaries
# originally from markdown document "season_temp_stats_v2.Rmd"
daily_mean_temps <- read.csv("other/inputs/temperature/observed_water_temp/daily_temp_metrics.csv") %>%
  select(Stream_Name,Site,year,Date,doy,daily_avg_temp) %>% 
  rename(site = Site) %>%
  transform(year = as.factor(year),
            Date = as.Date(Date))
```

</details>

<br>

### Diet Inputs

In the originally submitted manuscript, we used estimated dry mass values of prey items collected in gastric lavage samples, as executed below:

<details>

<summary>

*Show/Hide Code used prepare original fish diet data inputs from 2015-2016 observations (e.g. diet data in previous submission to TAFS)*

</summary>

```{r diet proportions}

#########################
#                       #
# B.) Diet Input        #
#                       #
#########################

# process 2015 & 2016 data simultaneously
# arrange to identical dataframe structures then combine before proceeding

# 1.) Import and arrange data

# 2015 Diet Data: Import & Arrange

#create objects from overall diet data google sheets
SCTC2015 <- "other/inputs/diet_size_other/2015 EPSCoR SCTC.xlsx"
SCTC2016 <- "other/inputs/diet_size_other/2016_EPSCoR_Aquatic_Ecology_Database.xlsx"

# read in worksheets containing diet data
diet15 <- read_excel(SCTC2015, sheet = "2015 Diet Contents Data") %>% 
  select(Sample.ID,
         Fish_Species,
         Sample.Event,
         sample.event.num,
         River,
         Reach,
         Site,
         Sample_Date,
         Prey_Type_Used,
         PreyCategory,
         Quantity,
         Total_Prey_Dry_Mass_mg) %>%
  mutate(year = "2015") %>%
  transform(sample.event.num = as.integer(sample.event.num),
            Quantity = as.numeric(Quantity),
            Total_Prey_Dry_Mass_mg = as.numeric(Total_Prey_Dry_Mass_mg))     # columns import as character for some reason unless specified! (weird but innocuous quirk)
  

diet16 <- read_excel(SCTC2016, sheet = "2016 Diet Contents Data") %>%
  select(Sample.ID,
         Fish_Species,
         Sample.Event,
         sample.event.num,
         River,
         Reach,
         Site,
         Sample_Date,
         Prey_Type_Used,
         PreyCategory,
         Quantity,
         Total_Prey_Dry_Mass_mg) %>%
  mutate(year = "2016") %>%
  transform(sample.event.num = as.integer(sample.event.num))
  
# combine 2015 and 2016 diet data
diet <- bind_rows(diet15, diet16)

# finalize structure of diet data
diet <- diet %>%  
  #rename needed columns  
  rename(sample.id = Sample.ID,
         spp = Fish_Species,
         sample.event = Sample.Event,
         event.num = sample.event.num,
         river = River,
         reach = Reach,
         site = Site,
         date = Sample_Date,
         prey = Prey_Type_Used,
         preycat = PreyCategory,
         quantity = Quantity,
         dm_mg = Total_Prey_Dry_Mass_mg) %>%
  
  #select desired columns
  select(sample.id,
         spp,
         sample.event,
         event.num,
         river,
         reach,
         site,
         date,
         year,
         prey,
         preycat,
         quantity,
         dm_mg) %>%
  
  #filter out non-diet samples and blank data
  filter(site!="DR1",
         !is.na(spp),
         !is.na(sample.event),
         !is.na(prey),
         !is.na(dm_mg),
         !is.na(quantity),
         !is.na(event.num)) %>%
  
  #transform columns to desired classes
  transform(dm_mg = as.numeric(dm_mg),
            sample.event = as.factor(sample.event),
            event.num = as.factor(event.num),
            date = mdy(date),
            spp = as.factor(spp),
            quantity = as.numeric(quantity),
            preycat = as.factor(preycat))  %>%
  mutate(season = fct_recode(event.num,         #code sampling events as seasons
                             "Early Summer"= "1", 
                             "Mid-Summer" = "2",
                             "Late Summer" = "3",
                             "Fall" = "4")) 

# save to local directory
write.csv(diet,"other/outputs/diet_v1.csv",row.names = F)

rm(diet15,diet16)
```

</details>

<br>

At this stage of analysis all prey items have an estimated dry mass value, which we acquired by measuring each item's length and applying the formula W = aL\^b, where "a" and "b" are parameters derived from the literature. These calculations of estimated dry mass values are available for download below:

```{r, echo = F}
embed_file("other/outputs/diet/diet_v1.csv",text = "Download Original Version of Diet Dry Mass Inputs (v1.0)")
```

<br>

However, to use these prey item mass values as inputs in our bioenergetics models, **we need them in wet weight rather than dry mass**. The original manuscript submitted to TAFS erroneously used dry weights.

To perform this needed transformation from dry mass to wet mass of prey items, we will apply wet/dry ratio values from the manuscript McCarthy 2009, along with four other literature sources. The downloadable table below summarises these wet/dry mass conversion and energy density values.

<br>

```{r, echo = F}
tbl <- read_excel("other/outputs/diet/mass_conversion/prey_types_manual_edit.xlsx",sheet = "data_validation") %>%
  filter(!is.na(prey_type))
```

```{r, echo = F}
embed_file("other/outputs/diet/mass_conversion/prey_types_manual_edit.xlsx",sheet = "data_validation",text = "Download dry/wet mass conversion values and energy densities of prey item categories.")
```

<br>

<details>

<summary>

*Show/Hide Code used prepare revised fish diet data inputs from 2015-2016 observations (e.g. diet data being converted to wet mass inputs)*

</summary>

```{r}

# General approach:
# We will generate and export a table of unique prey types (n = 127), then for each type manually assign one of the twelve prey type categories from McCarthy et al 2009 (+ several other lit sources)
# generate csv of unique prey types
unique_prey <- data.frame(unique(diet$prey)) %>%
  clean_names()
write.csv(unique_prey,"other/outputs/diet/mass_conversion/prey_types.csv",row.names = F)

# using the "prey_types.csv" file generated above, we will manually generate an excel file pairing each prey item with a category that has a known dry mass conversion value. 

# We will then join the dry mass conversion values back to the full diet data table

# read in dry mass conversion values
dm_convert_prey_types <- read_excel("other/outputs/diet/mass_conversion/prey_types_manual_edit.xlsx", sheet = "prey_types", skip = 1) %>%
  select(-notes)

dm_convert_vals <- read_excel("other/outputs/diet/mass_conversion/prey_types_manual_edit.xlsx", sheet = "data_validation") %>%
  filter(!is.na(prey_type))

dm_convert_vals <- left_join(dm_convert_prey_types,dm_convert_vals,by = "prey_type") %>%
  filter(!is.na(wet_dry_ratio)) %>%
  select(-notes) %>%
  rename(prey = unique_diet_prey)

# join dry mass conversion values (by prey type) to overall diet data set
diet <- left_join(diet,dm_convert_vals,by = "prey") %>%
  filter(!is.na(wet_dry_ratio)) 

# create new column of wet mass for individual prey items
diet %<>% mutate(wm_mg = dm_mg / wet_dry_ratio)

# summarise wet mass by diet category
#diet %<>%
 # select(-preycat) %>%
  #group_by(river,spp,###AGE diet,PreyCategory_ED,energy_density_jg) %>%
  #summarise(sum_wm_mg = sum(wm_mg))

# convert wet masses to diet category proportions
# and create column for summed wet mass of all prey categories
#wm_sum_tot <- diet %>%
 # ungroup() %>%
#  summarise(tot_sum_wm_mg = sum(sum_wm_mg)) %>%
 # as.numeric()

#z <- diet %>%
#  mutate(tot_sum_wm_mg = wm_sum_tot) %>%
#  mutate(diet_wm_prop = sum_wm_mg / tot_sum_wm_mg) %>%
#  select(PreyCategory_ED,diet_wm_prop) %>%
#  pivot_wider()

# only categories not matching are non-diet items (empty, destroyed, bait, etc)

# next : check out energy density tabel from v1 to see less granular version of preycat


## at this step, we need to convert prey dry mass in to wet mass and use that for the input

# what we originally did: prey length --> dm
# what we need to do: prey length --> dm --> wm

## reviewer 2: "convert each of the major prey categories into wet mass proportions (i.e., divide by proportion dry weight)". proportion of what?

### plan: continue prepping input files, return to here when dm --> wm conversion process clearer

# create prey categorization scheme specific to bioenergetics modeling purposes
# -import from google sheet "EPSCoR_SCTC_Prey_Energy_Densities" and mutate new column to diet data
# -this sheet also contains energy density assignments, which must be manually input in "fishbioenergetics.r"
# at a later step.



# remove temporary objects
#rm(diet15,diet16,ED)
```

</details>

<br>

At this stage, we now are using estimated wet weights for each diet item from each gastric lavage sample.

<br>

### Fish size and age

We will import fish size and age, then for those fish from which we collected gastric lavage samples, associate each fish with its own wet mass diet data.

<details>

<summary>

*Show/Hide Code used prepare fish age and size data inputs from 2015-2016 observations*

</summary>

```{r ,import all fish size and age data}

# NOTE ON AGE STRUCTURE 3/28/18
# This script originally imported google sheet titled "all_fish_ages.csv", which contained results output from the "fish_ages_all.R" script.  The "fish_ages_all.R" script used methods described in Ch. 5 of Ogle 2016 ("Introductory fisheries analyses with R") to age all captured fish from a subset of fish scale samples.  Resultant csv file was copied to the google sheet referenced here.

# Further consideration has determined that using age-length keys for this project may not best serve its interests.  In the column "Age_manual2" imported in this chunk, age thresholds were identified visually as described in "fish_age_structure.R".  

# ID googlesheet with fish age data (3/28/18: no longer in use)
#fish_ages <- gs_title("all_fish_ages.csv") 
#Sys.sleep(6)

# read in desired worksheet 2015
fish_ages15 <- read_excel(SCTC2015, sheet = "C 2015 Diet & LW Data") %>%
  select(river,sample.id,sample.event,spp,Weight_g,Length_mm,Age_manual2,sample.event.num,`Date...41`,`Site ID`,reach_name) %>%
  mutate(season = fct_recode(as.factor(sample.event.num), #code sampling events as seasons
                             "Early Summer"="1", 
                             "Mid-Summer" = "2",
                             "Late Summer" ="3")) %>%
  rename(wt_g = Weight_g,
         len_mm = Length_mm,
         age = Age_manual2,
         Hydrologic.Segment = reach_name) %>%
  transform(`Date...41` = anydate(`Date...41`)) %>%
  rename(Date = `Date...41`) %>%
  # filter out all species except Chinook and Coho
  filter(spp %in% c("Coho", "Chinook")) %>% 
  transform(wt_g = as.double(wt_g))


# read in desired worksheet 2016
fish_ages16 <- read_excel(SCTC2016, sheet = "C 2016 Diet & LW Data") %>%
  select(river,sample.id,sample.event,spp,Weight_g,Length_mm,Age_manual2,sample.event.num,Date,`Site ID`,reach_name) %>%
  mutate(season = fct_recode(as.factor(sample.event.num),         #code sampling events as seasons
                             "Early Summer"="1", 
                             "Mid-Summer" = "2",
                             "Late Summer" ="3",
                             "Fall" ="4")) %>%
  rename(wt_g = Weight_g,
         len_mm = Length_mm,
         age = Age_manual2,
         Hydrologic.Segment = reach_name) %>%
  transform(Date = anydate(Date),
            wt_g = as.numeric(wt_g)) %>%
  filter(spp %in% c("Coho", "Chinook")) # filter out all species except Chinook and Coho


#join 2015 and 2016 data
fish_ages <- bind_rows(fish_ages15,fish_ages16)

rm(fish_ages15,fish_ages16)

#prep dataframe containing age data
fish_ages <- fish_ages %>% 
  separate(sample.event, c("reach","year","sample.event.num"), sep = "-", remove = F) %>%
  unite(river_spp, river, spp, remove = F, sep = " ") %>%
  # manually order appearance of seasons and rivers for plots
  transform(year = as.factor(year),
            river = factor(river, levels=c("Beaver Creek",
                                              'Russian River',
                                              'Ptarmigan Creek',
                                              'Kenai River')),
            season = factor(season, levels = c("Early Summer",
                                     "Mid-Summer",
                                     "Late Summer",
                                     "Fall")), 
            river_spp = as.factor(river_spp)) %>%
  mutate(river_spp = paste(river,"\n",spp)) %>%
  mutate(doy = yday(Date)) %>%
  filter(!is.na(age))
 # age 2 fish: this cohort is sparse and likely departing for the ocean.
 #filter(age != 2) 


# prep fish ages dataframe for later results table generation at end of this code chunk. Also save external csv for use in other script(s)
fish_ages1 <- fish_ages
write.csv(fish_ages,"other/outputs/all_fish_age_size.csv",row.names = F)

# reduce dataframe width
fish_ages %<>%
  select(sample.id,Date,age,wt_g,len_mm)

#eliminate duplicate rows
## this code was not hashtagged in the original analysis ...
#fish_ages <- unique(fish_ages)

# join fish ages date with diet data      
diet <- left_join(diet, fish_ages, by = c("sample.id"))  %>%
  select(-date)



```

```{r}
# Generate table of fish size distribution by site

size_dist <- fish_ages1 %>%
  select(river,Hydrologic.Segment,spp,wt_g,len_mm,age) %>%
  filter(!is.na(wt_g),
         !is.na(len_mm)) %>%
  rename(reach = Hydrologic.Segment) %>%
  group_by(reach,river,spp,age) %>%
  summarise(mean_wt_g = round(mean(wt_g),1),
            stdev_wt_g = round(sd(wt_g),1),
            mean_len_mm = round(mean(len_mm),1),
            stdev_len_mm = round(sd(len_mm),1),
            mean_wt_g = paste0(mean_wt_g,"±",stdev_wt_g),
            mean_len_mm = paste0(mean_len_mm,"±",stdev_len_mm),
            n = n()) %>%
  select(-stdev_len_mm,-stdev_wt_g)

# use anti_join approach to remove all age 2 coho and age 1 chinook
anti_size_dist <- size_dist %>%
  filter(spp == "Coho" & age == 2 | spp == "Chinook" & age == 1)

# remove select spp/age cohorts via anti_join
size_dist <- anti_join(size_dist,anti_size_dist) %>%
  arrange(river,reach,spp,age)

# rename columns
size_dist %<>%
  rename(Reach = reach,
         Watershed = river,
         Species = spp,
         Age = age,
         `Mean Weight (g)` = mean_wt_g,
         `Mean Fork Length (mm)` = mean_len_mm,
         N = n)
  
```

</details>

<br>

```{r, echo = F}
# Overall summary of fish size, weight, and length values (mean ± SD).
dir <- "other/outputs/fish_size_distribution.csv"
write.csv(size_dist,dir, row.names = F)
embed_file(dir,text = "Download table of observed fish weight/length distributions")
```

Next, before proceeding with preparing diet proportions, we have a bit more work to do finalizing fish size and age data. For example, a few fish have diet data but no age. We will remove these fish.

##### How many fish have diet samples, but no age designation?

<details>

<summary>

*Show/Hide Code*

</summary>

```{r remove un-aged fish with diet samples}

# How many fish have diet samples, but no age designation?
diet_no_age <- diet %>%
  filter(is.na(age)) %>%
  distinct(sample.id)
diet_no_age <- nrow(diet_no_age)

#exclude these individuals
diet <- diet %>%
  filter(!is.na(age))

```

</details>

There are `r diet_no_age` fish with diet samples but no age manually assigned. These fish We will exclude these fish from analyses... for now, because we are running simulations seperately by age year/river/spp/age. Fish must have an age.

<br>

### Define scale of diet and growth input pooling/segregation

We will group fish growth simulation inputs at the space/time scale of:

-   Individual River (pool data among sites within each river)

-   Species (segregate Chinook vs coho)

-   Fish age (age 0 vs 1)

-   Year (2015 or 2016)

Diet data, however is pooled among years (2015 and 2016) due to the heterogenous nature of this type of data.

For example, an individual cohort of fish could be "2015 Beaver Creek Age 1 Coho." Diet data for this simulation is averaged from between 2015 and 2016.

<details>

<summary>

*Show/Hide Code*

</summary>

```{r}

#create sum of pooled prey DM for each prey category by fish species and sample event 
wm_sum_by_event <- diet %>%
  
  # choose level of diet input segregation here
  group_by(
    #year,
    #Hydrologic.Segment,
    #season,
    river,
    spp,
    PreyCategory_ED,
    age) %>%
  summarise(sum(wm_mg)) %>%
  rename(wm_sum =`sum(wm_mg)`) %>%
  spread(PreyCategory_ED,wm_sum) %>%
  rowwise() %>%
  # create column for summed dry mass of all prey categories
  mutate(wm_tot = sum(InvertTerrestrial,
                      InvertAquatic_AqOrigin,
                      InvertTerrestrial_AqOrigin,
                      FishEggs,    
                      SalmonEggs, 
                      na.rm = TRUE)) %>%
  mutate(FishEggs = FishEggs/wm_tot,
         # change prey quantities to relative proportions by category
         InvertAquatic_AqOrigin = InvertAquatic_AqOrigin/wm_tot,  
         InvertTerrestrial = InvertTerrestrial/wm_tot,
         InvertTerrestrial_AqOrigin = InvertTerrestrial_AqOrigin/wm_tot,
         SalmonEggs = SalmonEggs/wm_tot) %>%
  rename(Stream_Name = river) %>%
  select(-wm_tot) %>%
  # show only 3 decimal places
  mutate(across(where(is.numeric), round, 3))

```

</details>

<br>

```{r, echo = F}
write.csv(wm_sum_by_event,"other/outputs/diet/wet_mass_diet_proportions.csv",row.names = F)

embed_file("other/outputs/diet/wet_mass_diet_proportions.csv",text = "Download wet mass diet proportions by prey category for each fish cohort.")
```

<br>

##### Define temporal extents of proposed simulations

We set the time period of each simulation as the period of day leading up from the prior field sampling event. For example, suppose that one field sampling event at Lower Beaver Creek occurred on June 1, 2015 and the next one on July 1, 2015. In this case the simulations for "Early Summer Lower Beaver Creek" runs for 30 days and uses diet inputs based on field data from June 1, 2015. Overall, we constrained the time period of our summer growth simulations to the period of days for which field data was available form both 2015 and 2016.

<details>

<summary>

*Show/Hide Code used to determine temporal length of fish growth simulations*

</summary>

```{r, }
# Define temporal extents of proposed simulations

# NOTE 1/22/18: this code also exists as a script at "/Users/bmeyer/Google Drive/Thesis/R Analysis/Thesis Analyses R Project/Overall_scripts_2015_2016/sampling_periods.R".  Attempted to just source("\path") this script in to the markdown document but, 'source' function prevents knitting through markdown for some reason.  

############
#
# 2015
#
###########

#read in specific worksheet containing fishing data
effort2015 <- read_excel(SCTC2015, sheet ="B Fishing Data",skip=2) %>%
  #rename needed columns  
  rename(site.id=Site_ID,
         sample.event=Sample_Event) %>%
  
  #select desired columns
  select(site.id,Reach,River,sample.event,sample.event.num,deploy_dt,collect_dt) %>%
  
  #filter out blanks
  filter(!is.na(sample.event)) %>%
  
  # transform columns to desired classes
  transform(site.id=as.factor(site.id),
            sample.event=as.factor(sample.event),
            sample.event.num=as.factor(sample.event.num)) 


###################
#
# 2016
#
###################

#read in specific worksheet containing fishing data
effort2016 <- read_excel(SCTC2016, sheet = "B Fishing Data",skip=2) %>%
  
  #rename needed columns  
  rename(site.id=Site_ID,
         sample.event=Sample_Event) %>%
  
  #select desired columns
  select(site.id,Reach,River,sample.event,sample.event.num,deploy_dt,collect_dt) %>%
  
  #filter our blanks
  filter(!is.na(sample.event)) %>%
  
  # transform columns to desired classes
  transform(site.id=as.factor(site.id),
            sample.event=as.factor(sample.event),
            sample.event.num=as.factor(sample.event.num)) 


# bind 2015 & 2016 data; format datetimes
effort <- bind_rows(effort2015,effort2016) %>%
  transform(collect_dt = anytime(collect_dt),
            deploy_dt = anytime(deploy_dt)) %>%
  mutate(year = year(collect_dt)) %>%
  mutate(site = paste(Reach,River)) %>%
  filter(site != "Upper Ptarmigan Creek")

rm(effort2015,effort2016)


######### Next: Simulation extents, sites not grouped by river; separate by site

# Define Temporal Extents of proposed simulations 

# "Simulation" temporal extent
# Time period from first date of each season to first date of following season

# prepare data to tibble form
sim_extents_by_site <- effort %>% 
  #select(-site.id) %>%
  group_by(River,site,year,sample.event,sample.event.num) %>% 
  nest() %>% 
  mutate(season.start = purrr:: map_dbl(data, ~min(.$deploy_dt)),
         season.end = purrr:: map_dbl(data, ~min(.$deploy_dt))
         ) %>%
  transform(season.start = anytime(season.start),
            season.end = anytime(season.end)) %>%
  arrange(site,year,sample.event) 

# prepare data such that end of one season is beginning of next
t15 <- sim_extents_by_site %>% 
  filter(year == 2015) %>%
  mutate(season.end_x = lead(season.end)) %>%
  select(-season.end) %>%
  arrange(River,year,sample.event)

t16 <- sim_extents_by_site %>% 
  filter(year == 2016) %>%
  mutate(season.end_x = lead(season.end)) %>%
  select(-season.end) %>%
  arrange(River,year,sample.event)

# prepare data such that final season of each year has duration of 30 days.
# 2015 had 3 seasons, 2016 had 4 seasons.

t_end15 <- t15 %>%
  filter(sample.event.num == 3) %>%
  mutate(season.end = season.start + days(30)) %>%
  select(-season.end_x)

t_end16 <- t16 %>%
  filter(sample.event.num == 4) %>%
  mutate(season.end = season.start + days(30)) %>%
  select(-season.end_x)

t_end15_1 <- t15 %>%
  filter(sample.event.num != 3) %>%
  rename(season.end = season.end_x)

t_end16_1 <- t16 %>%
  filter(sample.event.num != 4) %>%
  rename(season.end = season.end_x) %>%
  filter(sample.event != "MPC-2016-3")

# NOTE: there was no 4th visit in 2016 to Middle Ptarmigan Creek due to logistical reasons and low CPUE.  Final season temporal extent is manually assigned here
mpc_2016_3 <- t16 %>%
  filter(sample.event == "MPC-2016-3") %>%
  select(-season.end_x) %>%
  mutate(season.end = season.start + days(30))

# remove old version
rm(sim_extents_by_site)

# final version of simulation extents
sim_extents_by_site <- bind_rows(t_end15_1,t_end15,t_end16_1,t_end16,mpc_2016_3) %>%
  rename(Stream_Name = River,
         sim.start = season.start,
         sim.end = season.end) %>%
  transform(year = as.factor(year)) %>%
  mutate(season = fct_recode(as.factor(sample.event.num), #code sampling events as seasons
                             "Early Summer"="1", 
                             "Mid-Summer" = "2",
                             "Late Summer" ="3",
                             "Fall" = "4")) %>%
  select(-data) %>%
  mutate(days = round(sim.end - sim.start))

# remove temporary objects
rm(t_end15,t_end15_1,t_end16,t_end16_1,mpc_2016_3)


# match temporal extent of simulated diet proportion data to simulation date if it exists. 
diet_prop_seasons <- left_join(wm_sum_by_event,sim_extents_by_site) %>%
  transform(days = as.double(days))

# save seasonal diet proportions for later download
write.csv(diet_prop_seasons,"other/outputs/observed_diet_proportions.csv",row.names = F)

# extend diet props down length of season
# diet proportions are static throughout season for now, can consider other approaches later
sim_diet_days <- diet_prop_seasons[rep(seq_len(nrow(diet_prop_seasons)),diet_prop_seasons[,"days"]), ]

# add a row # ("SimDay") per row within each desired sim group, 
sim_diet_days <- sim_diet_days %>%
  mutate(sim_name = paste0(year,"_",
                           season,"_",
                           site,"_",
                           spp,"_",
                           "Age","_",
                           age)) %>%
  group_by(sim_name) %>%
  mutate(SimDay = row_number()) %>%
  mutate(Date = sim.start + days(SimDay)) %>%
  transform(Date = date(Date))


# join daily mean temperatures with diet proportions
sim_diet_days <- left_join(sim_diet_days,daily_mean_temps,by=c("Date","site","Stream_Name","year")) %>%
  rename(avg_temp = daily_avg_temp)



# arrange and rename columns to format identical as in "InputFileTemplate" for bioenergetics modeling
sim_diet_days <- sim_diet_days %>%
  rename(diet1 = FishEggs,
         diet2 = InvertAquatic_AqOrigin,
         diet3 = InvertTerrestrial,
         diet4 = InvertTerrestrial_AqOrigin,
         diet5 = SalmonEggs,
         Temp = avg_temp) %>%
  # add in blank columns 7-10 to match InputFileTemplate format
  mutate(diet6 = 0,
        diet7 = 0,
         diet8 = 0,
         diet9 = 0,
         diet10 = 0) %>%
  # select desired columns  
  select(Date,SimDay,Temp,
         contains("Diet"),
         sim_name,spp) %>%
  # ensure that list of dataframes and list of dataframe names match up order in next step
  arrange(sim_name) %>%
  # round decimals to two digits
  mutate_if(is.numeric, funs(round(., 1))) %>%
  # filter out simulation days with no temperature data; trim lengths of sims to days w/ sims
  filter(!is.na(Temp)) 
  
#replace all NA's with 0's
sim_diet_days[is.na(sim_diet_days)] <- 0

# arrange columns in desired order
sim_diet_days <- sim_diet_days %>%
  select(Date,SimDay,Temp,diet1,diet2,diet3,diet4,diet5,diet6,diet7,diet8,diet9,diet10,sim_name,spp)

# remove Date column from sim_diet_days
sim_diet_days <- sim_diet_days %>%
  select(-Date)

```

</details>

<br>

```{r, echo = F}
# temperature data munging ... can we delete this whole code chunk?

# assign season names to each temperature observation

# remove non-simulation period temperature data 
#filtered_temperature_data  <- 
#    daily_mean_temps %>% 
#    rowwise() %>% 
#    mutate(present = any(Date >= sim_extents_by_site$sim.start & Date <= sim_extents_by_site$sim.end)) %>% 
#    filter(present) %>% 
#   data.frame() %>%
#    select(-present)

# create dataframe to specify simulation extents rounded to 15 minute intervals
z <- sim_extents_by_site %>%
  select(site,year,season,sim.start) %>%
  rename(DateTime = sim.start) %>%
  transform(DateTime = round_date(DateTime, unit = "15 min")) %>%
  mutate(Date = anydate(DateTime))

# QUESTION: do we need the df (z1) generated below?

# assign season names to each temperature observation  
# z1 <- left_join(filtered_temperature_data,z,by = c("Date","year","site")) %>%
#  fill(season, .direction = "down") %>%
 # remove any missing temperature data
#  filter(!is.na(season),
#         !is.na(daily_avg_temp)) %>%
#  select(-DateTime)

# remove temporary objects
rm(z,z1,filtered_temperature_data)


# export sim extent summary data to googlesheet
# gs_delete(gs_title("sim_extents_by_site"))
# gs_new("sim_extents_by_site", input = sim_extents_by_site)

```

```{r, echo = F}

# choose data for subset of simulations selected in script "fish_growth_size.Rmd"
# this list has been subset from the overall data using criteria described in "the above script "fish_growth_size_v4.Rmd".

# a.) import sheet with list of simulations subsetted (output table from "fish_growth_size_v4.Rmd")
sim_size_inputs_list <- read_excel("other/inputs/diet_size_other/sim_size_inputs_v2.xlsx",sheet = "lw_data") %>%
  select(sim)


## reduce the "sim_diet_days" df to contain only sims specificied in "sim_diet_inputs_list"
# a.) prep a sim_name_mod column in "sim_diet_days" for use in an inner_join with "sim_size_inputs_list"
z <- sim_diet_days %>%
  rename(sim = sim_name)

# b.) Filter table of diet proportion data to include only chosen subset of simulations
sim_diet_days <- inner_join(z,sim_size_inputs_list,by="sim") %>%
  distinct() %>%
  rename(sim_name = sim)

# dataframe containing all viable simulation inputs (as selected in script "fish_growth_size_v4.Rmd" is now present in "sim_diet_days")

# 6/19/2022: ensure that the list of unique simulation names matches the list of unique simulation names to generate "main inputs" folders matches the ...



```

```{r , echo= F}
n_sims <- sim_diet_days %>%
  select(sim_name) %>% 
  distinct() %>%
  nrow()

# write and make available for download all unique simulations
write.csv(sim_extents_by_site,"other/outputs/all_simulations.csv",row.names = F)

embed_file("other/outputs/all_simulations.csv",text = "Download list of all unique fish growth simulations")

embed_file("other/outputs/observed_diet_proportions.csv",text = "Download list of all observed diet proportions")

```

<br>

How many unique simulations are included? There `r n_sims` unique simulations based on fish age, species, river, year and season.

<br>

### Export files to be used as inputs in Fishbioenergetics 4.0

<br>

#### Diet proportion and water temperature csv file export prep

At this step, we will export csv files of diet proportions and water temperature unique to each iteration of year/season/river/species/age by day, each stored in the project directory folder named after the simulation. Each simulation will have a named folder containing the files "Diet_prop.csv" and "Temperature.csv." Other input files are generated in subsequent steps.

[Access bioenergetics simulation input files for download here:](https://github.com/benjamin-meyer-ak/kenai_juv_salmon_growth_analyses/tree/main/other/outputs/simulations)

<details>

<summary>

*Show/Hide Code used to prepare diet proportion and water temperature input files*

</summary>

```{r}
# a.) export water temperature csv files

## select desired variables
watertemps <- sim_diet_days %>%
  select(SimDay,Temp,sim_name,spp) %>%
  rename(day = SimDay,
         temperature = Temp) %>%
#recreate grouping variable
  group_by(sim_name)

# create individual dataframes for each species
watertemps_coho <- watertemps %>%
  filter(spp == "Coho") %>%
  select(-spp)

watertemps_chnk <- watertemps %>%
  filter(spp == "Chinook") %>%
  select(-spp)

# split up all data in to lists of individual simulations by year, river, species, age, and season
watertemps_list_coho <- split.data.frame(watertemps_coho, watertemps_coho$sim_name)
watertemps_list_chnk <- split.data.frame(watertemps_chnk, watertemps_chnk$sim_name)

# remove column containing name of simulation from all objects in list
watertemps_list_coho <- lapply(watertemps_list_coho, function(x) x[!(names(x) %in% c("sim_name"))])
watertemps_list_chnk <- lapply(watertemps_list_chnk, function(x) x[!(names(x) %in% c("sim_name"))])


# b.) diet proportion csv file export prep

# export diet proportion csv files

## select desired variables
dietprops <- sim_diet_days %>%
  select(-Temp) %>%
  rename(day = SimDay) %>%
#recreate grouping variable
  group_by(sim_name)

# create individual dataframes for each species
dietprops_coho <- dietprops %>%
  filter(spp == "Coho") %>%
  select(-spp)

dietprops_chnk <- dietprops %>%
  filter(spp == "Chinook") %>%
  select(-spp)

# split up all data in to lists of individual simulations by year, river, species, age, and season
dietprops_list_coho <- split.data.frame(dietprops_coho, dietprops_coho$sim_name)
dietprops_list_chnk <- split.data.frame(dietprops_chnk, dietprops_chnk$sim_name)

# remove column containing name of simulation from all objects in list
dietprops_list_coho <- lapply(dietprops_list_coho, function(x) x[!(names(x) %in% c("sim_name"))])
dietprops_list_chnk <- lapply(dietprops_list_chnk, function(x) x[!(names(x) %in% c("sim_name"))])

# choose 2015 - 2016 simulations inputs location
sim_dir <- "other/FB4.1_2015_2016/inputs/"

# eliminate overall existing directory and contents if applicable
unlink(sim_dir, recursive = T)

# create overall directory destination for input files
dir.create(sim_dir)

# name subdirectory paths
chnk_dir <- paste0(sim_dir,"chnk/")
coho_dir <- paste0(sim_dir,"coho/")

# eliminate existing sub-directory and contents if applicable
unlink(chnk_dir, recursive = T)
unlink(coho_dir, recursive = T)

# create directory destinations for input files
dir.create(chnk_dir)
dir.create(coho_dir)


# c.) export chinook diet proportions to csv files

# get names of all simulations in a list
dietprops_names_chnk <- dietprops_chnk %>%
  select(sim_name) %>%
  distinct()
dietprops_names_chnk <- as.list(dietprops_names_chnk)

# create sub-directory for each simulation
## get simulation names
### chinook
dietprops_names_chnk <- as.data.frame(dietprops_names_chnk) %>%
  mutate(folder_dir = paste0(chnk_dir,sim_name),
         diet_csv_dir1 = paste0(chnk_dir,"Diet_prop_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Diet_prop_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Diet_prop",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    dietprops_names_chnk$folder_dir)

# write diet proportion csv files
mapply(write.table,row.names = F, sep=",",
       dietprops_list_chnk, file = paste0(chnk_dir,"Diet_prop","_", names(dietprops_list_chnk),".csv"))

# move output files from chnk directory to individual simulation folders
Map(file.rename,
    from = dietprops_names_chnk$diet_csv_dir1,
    to = dietprops_names_chnk$diet_csv_dir2)

# rename each diet proportion csv file as "Diet_prop" to prepare for input to FB4
Map(file.rename,
    from = dietprops_names_chnk$diet_csv_dir2,
    to = dietprops_names_chnk$diet_csv_dir3)

# results: "Diet_prop.csv" exists in a named folder for each simulation


# d.) export chinook temperature data to csv files

# get names of all simulations in a list
watertemps_names_chnk <- watertemps_chnk %>%
  select(sim_name) %>%
  distinct()
watertemps_names_chnk <- as.list(watertemps_names_chnk)

# create sub-directory for each simulation
## get simulation names
### chinook
watertemps_names_chnk <- as.data.frame(watertemps_names_chnk) %>%
  mutate(folder_dir = paste0(chnk_dir,sim_name),
         diet_csv_dir1 = paste0(chnk_dir,"Temperature_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Temperature_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Temperature",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    watertemps_names_chnk$folder_dir)

# write temperature csv files
mapply(write.table,row.names = F, sep=",",
       watertemps_list_chnk, file = paste0(chnk_dir,"Temperature","_", names(watertemps_list_chnk),".csv"))

# move output files from chnk directory to individual simulation folders
Map(file.rename,
    from = watertemps_names_chnk$diet_csv_dir1,
    to = watertemps_names_chnk$diet_csv_dir2)

# rename each temperature csv file as "Temperature" to prepare for input to FB4
Map(file.rename,
    from = watertemps_names_chnk$diet_csv_dir2,
    to = watertemps_names_chnk$diet_csv_dir3)

# results: "Temperature.csv" exists in a named folder for each simulation



# e.) export coho diet proportions to csv files
# get names of all simulations in a list
dietprops_names_coho <- dietprops_coho %>%
  select(sim_name) %>%
  distinct()
dietprops_names_coho <- as.list(dietprops_names_coho)

# create sub-directory for each simulation
## get simulation names
dietprops_names_coho <- as.data.frame(dietprops_names_coho) %>%
  mutate(folder_dir = paste0(coho_dir,sim_name),
         diet_csv_dir1 = paste0(coho_dir,"Diet_prop_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Diet_prop_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Diet_prop",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    dietprops_names_coho$folder_dir)

# write diet proportion csv files
mapply(write.table,row.names = F, sep=",",
       dietprops_list_coho, file = paste0(coho_dir,"Diet_prop","_", names(dietprops_list_coho),".csv"))

# move output files from coho directory to individual simulation folders
Map(file.rename,
    from = dietprops_names_coho$diet_csv_dir1,
    to = dietprops_names_coho$diet_csv_dir2)

# rename each diet proportion csv file as "Diet_prop" to prepare for input to FB4
Map(file.rename,
    from = dietprops_names_coho$diet_csv_dir2,
    to = dietprops_names_coho$diet_csv_dir3)

# results: "Diet_prop.csv" exists in a named folder for each simulation



# f.) export coho temperature data to csv files

# get names of all simulations in a list
watertemps_names_coho <- watertemps_coho %>%
  select(sim_name) %>%
  distinct()
watertemps_names_coho <- as.list(watertemps_names_coho)

# create sub-directory for each simulation
## get simulation names
watertemps_names_coho <- as.data.frame(watertemps_names_coho) %>%
  mutate(folder_dir = paste0(coho_dir,sim_name),
         diet_csv_dir1 = paste0(coho_dir,"Temperature_",sim_name,".csv"), 
         diet_csv_dir2 = paste0(folder_dir,"/","Temperature_",sim_name,".csv"),
         diet_csv_dir3 = paste0(folder_dir,"/","Temperature",".csv"))

# create individual folders named after each simulation
Map(dir.create,
    watertemps_names_coho$folder_dir)

# write temperature csv files
mapply(write.table,row.names = F, sep=",",
       watertemps_list_coho, file = paste0(coho_dir,"Temperature","_", names(watertemps_list_coho),".csv"))

# move output files from coho directory to individual simulation folders
Map(file.rename,
    from = watertemps_names_coho$diet_csv_dir1,
    to = watertemps_names_coho$diet_csv_dir2)

# rename each diet proportion csv file as "Temperature" to prepare for input to FB4
Map(file.rename,
    from = watertemps_names_coho$diet_csv_dir2,
    to = watertemps_names_coho$diet_csv_dir3)

# results: "Temperature.csv" exists in a named folder for each simulation


```

</details>

<br>

#### Other input files generation

Other input files required for bioenergetics simulations remain static throughout all simulations. These file types include:

-   Indigestable_Prey.csv

-   Pred_E.csv

-   Prey_E.csv

We will generate these files and place them within each simulation folder.

<details>

<summary>

*Show/Hide Code used to prepare static input files for bioenergtics simulations*

</summary>

```{r}
# write the three constant Main Input files to local directory folder

## Indigestible prey
day <- c(1,365)
diet1 <- .03
diet2 <- .17
diet3 <- .17
diet4 <- .17
diet5 <-  0.3  
diet6 <- 0
diet7 <- 0
diet8 <- 0 
diet9 <- 0
diet10 <- 0

# collate to data frame
Indigestible_Prey <- data.frame(day,diet1,diet2,diet3,diet4,diet5,
                                diet6,diet7,diet8,diet9,diet10)

# create folder for static inputs
static_inputs_dir <- paste0(sim_dir,"Main_Inputs","/")
unlink(static_inputs_dir, recursive = T)
dir.create(static_inputs_dir)

# write file
write.csv(Indigestible_Prey,paste0(static_inputs_dir,"Indigestible_Prey.csv"), row.names = F)

  
## Pred_E.csv
predator <- 5000
# collate to data frame
Pred_E <- data.frame(day,predator)
# write file
write.csv(Pred_E, paste0(static_inputs_dir,"Pred_E.csv"), row.names = F)


## Prey_E.csv
### see sheet "EPSCoR_SCTC_Prey_Energy_Densities"
diet1 <- 5235 # FishEggs
diet2 <- 3365 # InvertAquatic_AqOrigin
diet3 <- 5250 # InvertTerrestrial
diet4 <- 4225 # InvertTerrestrial_AqOrigin
diet5 <- 9000 # SalmonEggs
diet6 <- 0 
diet7 <- 0
diet8 <- 0
diet9 <- 0
diet10 <- 0
  
Prey_E <- data.frame(day,diet1,diet2,diet3,diet4,diet5,
                     diet6,diet7,diet8,diet9,diet10)

write.csv(Prey_E, paste0(static_inputs_dir,"Prey_E.csv"), row.names = F)



####################################################################

## Place static value files in each simulation folder
## Approach: same as other csv exports; create list of dataframes and use mapply to export

## proceed by individual species and file type

# chinook - Indigestible Prey

# get master copy file directory for indigestible prey
ip_dir <- paste0(static_inputs_dir,"Indigestible_Prey.csv")

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = chnk_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Indigestible_Prey",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = ip_dir,
    to = z$sim_dir,
    overwrite = T)


# chinook - Pred_E.csv file export

# get master copy file directory for indigestible prey
pe_dir <- paste0(static_inputs_dir,"Pred_E.csv")

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = chnk_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Pred_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = pe_dir,
    to = z$sim_dir,
    overwrite = T)
  


# chinook - Prey_E.csv export
# get master copy file directory for indigestible prey

pred_dir <- paste0(static_inputs_dir,"Prey_E.csv")

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = chnk_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Prey_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = pred_dir,
    to = z$sim_dir,
    overwrite = T)




# coho - Indigestible prey csv export

# get master copy file directory for indigestible prey
ip_dir <- paste0(static_inputs_dir,"Indigestible_Prey.csv")

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = coho_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Indigestible_Prey",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = ip_dir,
    to = z$sim_dir,
    overwrite = T)

# coho - Pred_E.csv export

# get master copy file directory for indigestible prey
pe_dir <- paste0(static_inputs_dir,"Pred_E.csv")

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = coho_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Pred_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = pe_dir,
    to = z$sim_dir,
    overwrite = T)


# coho - Prey_E.csv export

# get master copy file directory for indigestible prey
pred_dir <- paste0(static_inputs_dir,"Prey_E.csv")

# Get list of folders in directory destination
z <- as.data.frame(list.dirs(path = coho_dir)) 
z <- as.data.frame(z[-1, ], drop = F) 
colnames(z) <- "sim_dir"
z <- z %>%
  mutate(simx = str_replace(z$sim_dir,"//","/")) %>%
  select(-sim_dir) %>%
  mutate(sim_dir = paste0(simx,"/","Prey_E",".csv")) %>%
  select(-simx)
  
# write same csv file to all simulation sub-folders
Map(file.copy,
    from = pred_dir,
    to = z$sim_dir,
    overwrite = T)

```

</details>

<br>

Next, we will prepare the "Initial Settings" file for the Fishbioenergetics multi-simulation run, with unique start/end weights for multiple simulations. We will fit simulations to final weight.

<details>

<summary>

*Show/Hide Code used to prepare the Initial Settings file*

</summary>

```{r}
# Clear environment
#rm(list=ls())

# 6/19/2022 --- we need to ensure that the "sim_size_inputs_v2" list of unique simulations matches the list of unique sims that we just used to generate main inputs

# get list of unique simulations for which main input files were generated
unique_sims <- data.frame(unique(dietprops$sim_name))
colnames(unique_sims) <- "sim"

# use the above list to subset list of length/weights for master simulation list file
sim_size_inputs_FB4.1 <- read_excel("other/inputs/diet_size_other/sim_size_inputs_v2.xlsx",sheet = "lw_data") %>% inner_join(unique_sims)
  

sim_size_inputs_FB4.1 %<>% 
  # create a "species column"
  separate(sim,into = c("year","season","site","spp","foo","age"),sep="\\_",remove = F) %>%
  select(-one_of("year","site","age","season","foo")) %>%
  rename(Simulation = sim,
         # using mean backcalculated weight values by spp/age/sample.event
         Init_W = wt_start) %>%
  mutate(fit.to = "Weight",
         # This input set is formatted to use final lm weight as fitting values
         fitting_value = wt_end,   
         Sp_label = "salmon (adult)",
         Sp = paste(spp,Sp_label),
         First_day = 1,
         Last_day = sim.end.doy - sim.start.doy,
         Ind = 1,
         Oxycal = 13560,
         calc.nut = "FALSE",
         calc.contaminant = "FALSE",
         X_Pred = "NA",
         CONTEQ = 1,
         calc.pop_mort = "FALSE",
         calc.spawn = "FALSE") %>%
  # species abbreviations for folder names
  mutate(spp2 = ifelse(spp == "Chinook", "chnk", ifelse(spp == "Coho", "coho",spp))) %>%
  # create file path for input folders
  mutate(input_folder = paste0("inputs/",spp2,"/",Simulation)) %>%
  # select final column names for input file
  select(Simulation, Sp, input_folder,	
         fit.to,	Init_W, fitting_value ,
         First_day, Last_day, Ind, Oxycal,
         calc.nut, calc.contaminant, X_Pred, 
         CONTEQ, calc.pop_mort, calc.spawn)

## save input csv to local directory
# name directory location
input_csv_dir <- "other/FB4.1_2015_2016/sim_size_inputs_FB4.1.csv"

# remove any previous output versions
file.remove(input_csv_dir)

# write new csv file
write.csv(sim_size_inputs_FB4.1, input_csv_dir, row.names = T)

```

</details>

<br>

We now have a csv for simulation size inputs stored in the project GitHub repository at "other/outputs/simulations/sim_size_inputs_FB4.1.csv", and a folder directory containing 5 csv files for each individual simulation is stored at "other/outputs/simulations/".

[Access these simulation input files here.](https://github.com/benjamin-meyer-ak/kenai_juv_salmon_growth_analyses/tree/main/other/FB4.1_2015_2016)

<br>

Update `r Sys.Date()`: we are now instead proceeding with using published FB4 1.1.3 software (download at [fishbioenergetics.org](http://fishbioenergetics.org/)), which uses the "Design File" structure to initiate multiple simulation runs. We will restructure our "Initial Settings" file to match the Design File structure.

<details>

<summary>

*Show/Hide Code used to prepare the Design file*

</summary>

```{r}

# Clear environment
#rm(list=ls())

# copy all input files over to FB4 v1.1.3 folder
### not sure how to do this programatically, did it manually for now 6/19/2022

# 6/19/2022 --- we need to ensure that the "sim_size_inputs_v2" list of unique simulations matches the list of unique sims that we just used to generate main inputs

# get list of unique simulations for which main input files were generated
unique_sims <- data.frame(unique(dietprops$sim_name))
colnames(unique_sims) <- "sim"

# use the above list to subset list of length/weights for master simulation list file
sim_size_inputs_FB4.1 <- read_excel("other/inputs/diet_size_other/sim_size_inputs_v2.xlsx",sheet = "lw_data") %>% inner_join(unique_sims)


# 6/19/2022 - there appears to still be a mismatch between the list of "main input" folder directories and the list of simulation names in the design file. Here we will work to diagnose where the mismatch lies, and rectify the two lists.


# Get list of folders in directory for each species
coho_dirs <- as.data.frame(list.dirs(path = "other/FB4_1.1.3_2015_2016.1/coho"))
colnames(coho_dirs) <- "dir"
chnk_dirs <- as.data.frame(list.dirs(path = "other/FB4_1.1.3_2015_2016.1/chnk"))
colnames(chnk_dirs) <- "dir"
folder_dirs <- bind_rows(coho_dirs,chnk_dirs) %>%
  clean_names() %>%
  separate(dir,sep = "/",into = c("a","b","c","sim")) %>%
  filter(!is.na(sim)) %>%
  select("sim")

# again, use the above list to subset list of length/weights for master simulation list file
sim_size_inputs_FB4.1 %<>% 
  inner_join(folder_dirs)


# create design input file
design_2015_2016 <- sim_size_inputs_FB4.1 %>%
  # mutate column with species abbreviations
  mutate(spp_v2 = case_when(
      spp == "Coho" ~ "coho",
      spp == "Chinook" ~ "chnk")) %>%
  mutate(
    NRun = row_number(),
    Run_Name = sim,
    Species_Num = case_when(
      spp == "Coho" ~ "22",
      spp == "Chinook" ~ "21"),
    Species_txt = case_when(
      spp == "Coho" ~ "Coho salmon (adult)",
      spp == "Chinook" ~ "Chinook salmon (adult)"),
    Initial_W = wt_start,
    fit.to = "Weight",
    fit.to.value = wt_end,
    First_day = 1,
    Last_day = sim.end.doy - sim.start.doy,
    N_indiv = 1,
    Oxycal = 13560,
    calc.pop_mort = "FALSE",
    calc.spawn = "FALSE",
    calc.nut = "FALSE",
    calc.contaminant = "FALSE",
    Init_pred_conc = "NA",
    contam_eq = "NA",
    T_File = paste0(spp_v2,"/",Run_Name,"/","Temperature.csv"),
    Diet_File = paste0(spp_v2,"/",Run_Name,"/","Diet_prop.csv"),
    Prey_E_File = paste0(spp_v2,"/",Run_Name,"/","Prey_E.csv"),
    Indigest_Prey_File = paste0(spp_v2,"/",Run_Name,"/","Indigestible_Prey.csv"),
    Pred_E_File = paste0(spp_v2,"/",Run_Name,"/","Pred_E.csv"),
    Mort_File = "NA",
    Reprod_File = "NA",
    Contam_Prey_C_File = "NA",
    Contam_assim_File = "NA",
    Contam_TE_File = "NA",
    Phos_Ae_File = "NA",
    Phos_Co_Pred_File = "NA",
    Phos_Co_Prey_File = "NA",
    Nit_Ae_File = "NA",
    Nit_Co_Pred_File = "NA",
    Nit_Co_Prey_File = "NA",
    FB4_Log_File = "FB4_2015_2016_models.csv",
    .keep = "unused")

# select final column names for input file
# get all column names design file example
design_colnames <- read.csv("other/FB4_1.1.3_2015_2016.1/FB4_Design_Bluegill_1.csv") %>% colnames()

# select from subset of column in aqwms template
 design_2015_2016 %<>%
  select(one_of(design_colnames))


## save input csv to local directory
# name directory location
input_csv_dir <- "other/FB4_1.1.3_2015_2016.1/design_2015_2016.csv"

# remove any previous output versions
file.remove(input_csv_dir)

# write new csv file
write.csv(design_2015_2016, input_csv_dir, row.names = F)

# 6/19/2022 - app produces output in "FB4_2015_2016_models.csv"

```

</details>

Note: we achieved success with running the 2015-2016 simulations using the design file "design_2015_2016_final.csv," with simulation outputs at "FB4_2015_2016_models.csv." The "_final.csv" file was manually edited in two instances to change simulation length to make one day shorter to match time lengths in the main input files. Reason for mismatch is unclear, but a 1-day mismatch timespan is insuffcient to potentially affect results.

```{r, echo = F}
embed_file("other/FB4_1.1.3_2015_2016.1/FB4_2015_2016_models.csv",text = "Download Model Outputs from 2015-2016 data using Fishbioenergetics v1.1.3")
```



```{r, echo = F}

# 5/19/22 - status: custom version of FB4.1 won't run, throws error "Error in if (input_file_list %in% list.files(folder)) { : 
#  the condition has length > 1"
# code is in "global.R" file

# next steps: try to figure out new public release of fb4, which has "design" function for multiple simulations?

# see also custom app created by Shaun Garnett (Upwork) at https://bemeyer.shinyapps.io/FishBioenergetics/

```

```{r, eval = F, echo = F}

# format for making code foldable

##Explanation here...

 ##<details>

##<summary>

##*Show/Hide Code used to determine temporal length of fish growth simulations*

##</summary>

### code chunk here

## </details>




```

```{r nice-fig, fig.cap='Here is a nice figure!', out.width='80%', fig.asp=.75, fig.align='center', echo = F, eval = F}
#You can label chapter and section titles using `{#label}` after them, e.g., we can reference Chapter \@ref(intro). If you do not manually label them, there will be automatic labels anyway, e.g., Chapter \@ref(methods).

#Figures and tables with captions will be placed in `figure` and `table` environments, respectively.


par(mar = c(4, 4, .1, .1))
plot(pressure, type = 'b', pch = 19)
```

```{r nice-tab, tidy=FALSE, echo = F, eval = F}
# Reference a figure by its code chunk label with the `fig:` prefix, e.g., see Figure \@ref(fig:nice-fig). Similarly, you can reference tables generated from `knitr::kable()`, e.g., see Table \@ref(tab:nice-tab).

knitr::kable(
  head(iris, 20), caption = 'Here is a nice table!',
  booktabs = TRUE
)

# You can write citations, too. For example, we are using the **bookdown** package [@R-bookdown] in this sample book, which was built on top of R Markdown and **knitr** [@xie2015].
```
